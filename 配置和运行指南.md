# 混合模式实时语音集成 - 配置和运行指南

## 📋 需要配置的内容

### 1. 后端环境变量配置

在 `backend-api/.env` 文件中添加以下配置：

```bash
# ========================================
# RTC+ASR服务配置（必需 - 选择一种）
# ========================================

# 方案A：火山引擎（推荐）
RTC_PROVIDER=volcengine
RTC_APP_ID=your_volcengine_app_id
RTC_APP_KEY=your_volcengine_app_key
RTC_REGION=cn-north-1

# 方案B：声网（备选）
# RTC_PROVIDER=agora
# RTC_APP_ID=your_agora_app_id
# RTC_APP_KEY=your_agora_app_key
# RTC_TOKEN=your_agora_token

# ========================================
# 您现有的配置（检查是否已配置）
# ========================================

# DeepSeek LLM（必需）
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# 阿里云TTS（必需）
ALIYUN_TTS_ACCESS_KEY_ID=your_aliyun_access_key_id
ALIYUN_TTS_ACCESS_KEY_SECRET=your_aliyun_access_key_secret
ALIYUN_TTS_REGION=cn-shanghai
ALIYUN_TTS_VOICE=siqi

# TTS服务提供商
TTS_PROVIDER=aliyun

# ========================================
# 服务端口配置（可选）
# ========================================
PORT=3001
NODE_ENV=development
```

---

## 🚀 需要运行的服务

### 服务列表

| 服务 | 端口 | 必需性 | 说明 |
|------|------|--------|------|
| **后端API服务** | 3001 | ✅ 必需 | Node.js后端 + WebSocket |
| **数据库** | 3306 | ✅ 必需 | MySQL/PostgreSQL（如果使用） |
| **Redis** | 6379 | ⚠️ 可选 | 用于缓存和队列 |

### 1. 启动后端服务（必需）

```bash
cd backend-api

# 安装依赖（如果还没安装）
npm install

# 启动开发服务器（会自动加载.env文件）
npm run dev

# 或启动生产服务器
npm run build
npm start
```

**预期输出**：
```
🚀 AI面试系统后端服务已启动
📍 服务地址: http://localhost:3001
📚 API文档: http://localhost:3001/api/docs
🌟 环境: development
🎭 Fay WebSocket服务: ws://localhost:3001
🎤 实时语音WebSocket服务: ws://localhost:3001
✅ 实时语音服务初始化成功
```

---

### 2. 检查服务状态

#### 检查后端服务

```bash
# 健康检查
curl http://localhost:3001/health

# 应该返回：
# {"status":"OK","timestamp":"...","version":"1.0.0"}
```

#### 检查WebSocket服务

```bash
# 使用wscat测试（需要安装：npm install -g wscat）
wscat -c ws://localhost:3001

# 连接成功后，发送测试消息：
{"event":"join_session","data":{"sessionId":"test-123"}}
```

---

## 🔧 配置步骤详解

### 步骤1：获取火山引擎API密钥（推荐）

1. **访问火山引擎控制台**
   - 网址：https://www.volcengine.com/product/veRTC
   - 注册/登录账号

2. **创建应用**
   - 进入控制台 → 创建应用
   - 记录 `AppID` 和 `AppKey`

3. **配置到环境变量**
   ```bash
   RTC_PROVIDER=volcengine
   RTC_APP_ID=your_app_id_here
   RTC_APP_KEY=your_app_key_here
   RTC_REGION=cn-north-1
   ```

### 步骤2：验证现有配置

检查以下配置是否已存在：

```bash
# 检查DeepSeek配置
echo $DEEPSEEK_API_KEY

# 检查阿里云TTS配置
echo $ALIYUN_TTS_ACCESS_KEY_ID
echo $ALIYUN_TTS_ACCESS_KEY_SECRET
```

如果未配置，参考：
- DeepSeek：https://platform.deepseek.com/api_keys
- 阿里云TTS：https://ram.console.aliyun.com/

### 步骤3：配置Android端

在 `DigitalInterviewScreen.kt` 中设置服务器地址：

```kotlin
// 开发环境
val serverUrl = "http://192.168.1.100:3001" // 替换为您的电脑IP

// 生产环境
val serverUrl = "https://your-domain.com"
```

---

## 📊 服务依赖关系

```
┌─────────────────────────┐
│   Android App           │
│   (需要配置服务器地址)   │
└─────────────────────────┘
           ↓ WebSocket
┌─────────────────────────┐
│   后端API服务            │
│   (端口3001)            │
│   ✅ 必需运行            │
└─────────────────────────┘
           ↓ API调用
┌─────────────────────────┐
│   第三方服务（云端）     │
│   - 火山引擎/声网 ASR   │
│   - DeepSeek LLM        │
│   - 阿里云TTS           │
│   ✅ 需要API密钥        │
└─────────────────────────┘
```

---

## ✅ 配置检查清单

### 后端配置

- [ ] `.env` 文件已创建
- [ ] `RTC_PROVIDER` 已配置（volcengine 或 agora）
- [ ] `RTC_APP_ID` 已配置
- [ ] `RTC_APP_KEY` 已配置
- [ ] `DEEPSEEK_API_KEY` 已配置
- [ ] `ALIYUN_TTS_ACCESS_KEY_ID` 已配置
- [ ] `ALIYUN_TTS_ACCESS_KEY_SECRET` 已配置

### 服务运行

- [ ] 后端服务已启动（`npm run dev`）
- [ ] WebSocket服务已初始化（查看日志）
- [ ] 端口3001未被占用
- [ ] 防火墙允许3001端口

### Android配置

- [ ] Socket.IO依赖已添加
- [ ] 权限已添加（RECORD_AUDIO, INTERNET）
- [ ] 服务器地址已配置
- [ ] RealtimeVoiceManager已集成

---

## 🧪 测试步骤

### 1. 测试后端服务

```bash
# 1. 启动服务
cd backend-api
npm run dev

# 2. 检查健康状态
curl http://localhost:3001/health

# 3. 检查日志
# 应该看到：
# ✅ 实时语音服务初始化成功
# 🎤 实时语音WebSocket服务: ws://localhost:3001
```

### 2. 测试WebSocket连接

使用浏览器控制台测试：

```javascript
// 在浏览器控制台运行
const socket = io('http://localhost:3001');

socket.on('connect', () => {
  console.log('✅ WebSocket连接成功');
  
  // 加入会话
  socket.emit('join_session', {
    sessionId: 'test-session-123'
  });
});

socket.on('session_joined', (data) => {
  console.log('✅ 会话加入成功:', data);
});

socket.on('error', (error) => {
  console.error('❌ 错误:', error);
});
```

### 3. 测试Android端

1. 运行Android应用
2. 查看Logcat日志（搜索 `RealtimeVoiceManager`）
3. 开始面试
4. 检查WebSocket连接状态

---

## 🔍 常见问题排查

### Q1: WebSocket连接失败

**检查**：
```bash
# 1. 检查服务是否运行
curl http://localhost:3001/health

# 2. 检查端口是否被占用
lsof -i :3001

# 3. 检查防火墙
# macOS: 系统设置 → 防火墙
```

### Q2: RTC服务未初始化

**检查**：
```bash
# 查看后端日志
# 应该看到：
# ✅ 实时语音服务初始化成功

# 如果看到：
# ⚠️ RTC服务未配置，将使用模拟模式
# 说明环境变量未正确配置
```

### Q3: Android端无法连接

**检查**：
1. 服务器地址是否正确（不要用localhost，用IP地址）
2. 网络是否连通（ping服务器IP）
3. 防火墙是否允许连接

---

## 📝 最小化配置（快速测试）

如果只想快速测试，可以使用**模拟模式**：

```bash
# backend-api/.env
# 不配置RTC服务（会使用模拟模式）
# RTC_PROVIDER=volcengine
# RTC_APP_ID=
# RTC_APP_KEY=

# 只配置必需的LLM和TTS
DEEPSEEK_API_KEY=your_key
ALIYUN_TTS_ACCESS_KEY_ID=your_key
ALIYUN_TTS_ACCESS_KEY_SECRET=your_secret
```

**注意**：模拟模式下ASR会返回模拟文本，但可以测试完整流程。

---

## 🎯 推荐配置顺序

1. **第一步**：配置环境变量（`.env`文件）
2. **第二步**：启动后端服务（`npm run dev`）
3. **第三步**：检查服务状态（`/health`端点）
4. **第四步**：测试WebSocket连接
5. **第五步**：配置Android端
6. **第六步**：测试完整流程

---

## 📚 相关文档

- `混合模式实现完成.md` - 完整实现说明
- `集成示例.md` - 集成示例代码
- `快速开始指南.md` - 快速开始步骤
- `第三方数字人API服务对比.md` - API服务对比

---

**总结**：只需要运行**后端API服务**（一个服务），其他都是云端API调用。

