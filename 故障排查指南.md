# 🔍 数字人语音交互故障排查指南

> 说话没有反馈？让我们一步步排查！

---

## 📋 快速诊断清单

按顺序检查以下项目：

- [ ] 1. 后端服务是否启动
- [ ] 2. WebSocket 是否连接成功
- [ ] 3. 麦克风权限是否授予
- [ ] 4. 录音是否正常工作
- [ ] 5. 音频数据是否发送到后端
- [ ] 6. ASR 服务是否配置（如需语音识别）
- [ ] 7. 查看详细日志

---

## 🔧 步骤一：检查后端服务

### 1. 确认后端已启动

```bash
# 终端 1: 启动后端（如果没启动）
cd backend-api
npm run dev
```

看到这些日志说明启动成功：
```
✅ TTS服务已配置
✅ DeepSeek服务已初始化
🚀 Server started on http://localhost:3001
```

### 2. 测试后端健康检查

```bash
# 终端 2: 测试连接
curl http://localhost:3001/health
```

应该返回：
```json
{"status":"OK","timestamp":"...","version":"1.0.0"}
```

---

## 📱 步骤二：检查 Android 连接

### 1. 查看 Android 日志

```bash
# 实时查看应用日志
adb logcat | grep -E "RealtimeVoiceManager|DigitalInterview|WebSocket"
```

**正常日志应该包含：**
```
I RealtimeVoiceManager: 初始化语音管理器
I RealtimeVoiceManager: WebSocket 连接中...
I RealtimeVoiceManager: ✅ WebSocket 已连接
I RealtimeVoiceManager: 会话已初始化
```

**如果看到错误：**
```
E RealtimeVoiceManager: WebSocket 连接失败
E RealtimeVoiceManager: 连接超时
```

说明后端连接有问题！

### 2. 检查 WebSocket 地址配置

```kotlin
// 打开 AppConfig.kt 检查
// android-v0-compose/app/src/main/java/com/xlwl/AiMian/config/AppConfig.kt

object AppConfig {
    const val realtimeVoiceWsUrl = "ws://你的IP:3001"  // 检查这个
}
```

**常见错误：**
- ❌ `ws://localhost:3001` - 不能用 localhost
- ❌ `ws://127.0.0.1:3001` - 手机访问不到
- ✅ `ws://192.168.1.100:3001` - 使用电脑的局域网 IP

**查看本机 IP：**
```bash
# Mac/Linux
ifconfig | grep "inet " | grep -v 127.0.0.1

# 或者
ipconfig getifaddr en0  # WiFi
ipconfig getifaddr en1  # 有线
```

---

## 🎤 步骤三：检查录音功能

### 1. 查看录音权限

在 Android 应用中：
- 进入 设置 → 应用 → AI面试系统 → 权限
- 确保 **麦克风** 权限已授予

### 2. 查看录音日志

```bash
# 查看录音相关日志
adb logcat | grep "录音\|Recording\|Audio"
```

**正常日志：**
```
I RealtimeVoiceManager: 开始录音
I RealtimeVoiceManager: 录音器已启动
I RealtimeVoiceManager: 发送音频数据，大小: 1024 bytes
```

**如果没有这些日志，说明录音没有启动！**

---

## 🔌 步骤四：检查数据传输

### 方法 1: 查看后端接收日志

```bash
# 终端 3: 查看后端日志（启动后端时加 DEBUG）
cd backend-api
DEBUG=* npm run dev
```

**应该看到：**
```
🔗 客户端已连接: xxxxx
✅ 用户加入会话: test-session-xxx
🎤 收到音频数据 (Session: xxx, Size: 1024 bytes)
```

**如果没有"收到音频数据"，说明数据没有发送到后端！**

### 方法 2: 添加调试日志到 Android

临时添加日志来调试：

```kotlin
// 在 RealtimeVoiceManager.kt 的 startRecording() 方法中添加

fun startRecording() {
    Log.d(TAG, "🎤 [DEBUG] startRecording() 被调用")
    
    if (_isRecording.value) {
        Log.w(TAG, "⚠️ [DEBUG] 已经在录音中，跳过")
        return
    }
    
    Log.d(TAG, "📱 [DEBUG] 检查权限...")
    // ... 权限检查代码
    
    Log.d(TAG, "🎙️ [DEBUG] 创建 AudioRecord...")
    audioRecord = AudioRecord(...)
    
    Log.d(TAG, "▶️ [DEBUG] 启动录音...")
    audioRecord?.startRecording()
    
    Log.d(TAG, "✅ [DEBUG] 录音已启动，开始读取数据...")
    
    recordingJob = scope.launch {
        while (isActive && _isRecording.value) {
            val buffer = ByteArray(bufferSize)
            val readBytes = audioRecord?.read(buffer, 0, buffer.size) ?: 0
            
            Log.d(TAG, "📊 [DEBUG] 读取音频: $readBytes bytes")
            
            if (readBytes > 0) {
                Log.d(TAG, "📤 [DEBUG] 准备发送音频到服务器...")
                sendAudioData(buffer.copyOf(readBytes))
            }
        }
    }
}
```

---

## 🐛 步骤五：常见问题排查

### 问题 1: "语音服务连接中…" 一直不变

**原因**: WebSocket 连接失败

**解决方案**:
```bash
# 1. 检查后端是否启动
lsof -i :3001

# 2. 检查防火墙
# Mac: 系统偏好设置 → 安全性与隐私 → 防火墙 → 允许 Node

# 3. 检查 IP 地址
# 确保手机和电脑在同一 WiFi
```

### 问题 2: 点击"开始答题"没反应

**原因**: 
- 权限未授予
- 录音初始化失败
- WebSocket 未连接

**解决方案**:
```kotlin
// 检查 DigitalInterviewScreen.kt 的 toggleRecording 函数

val toggleRecording: () -> Unit = {
    Log.d("DigitalInterview", "🔘 [DEBUG] toggleRecording 被点击")
    
    when {
        !hasMicrophonePermission -> {
            Log.w("DigitalInterview", "⚠️ [DEBUG] 没有麦克风权限")
            showPermissionDialog = true
        }
        
        connectionState != ConnectionState.CONNECTED -> {
            Log.w("DigitalInterview", "⚠️ [DEBUG] WebSocket 未连接: $connectionState")
            Toast.makeText(context, "语音服务尚未连接", Toast.LENGTH_SHORT).show()
        }
        
        else -> {
            Log.d("DigitalInterview", "✅ [DEBUG] 开始录音")
            voiceManager.startRecording()
        }
    }
}
```

### 问题 3: 没有 ASR 服务配置

**如果你没有配置 ASR（火山引擎），后端无法识别语音！**

**解决方案 A**: 配置 ASR 服务
```bash
# 在 backend-api/.env 中添加
VOLC_APP_ID=你的AppID
VOLC_ACCESS_KEY=你的AccessKey
VOLC_SECRET_KEY=你的SecretKey
```

**解决方案 B**: 使用文本输入模式（推荐先测试）
```kotlin
// 暂时改用文本输入测试连接
voiceManager.sendTextMessage("你好，这是测试消息")
```

---

## 📊 完整的调试日志流程

### Android 端日志（正常流程）

```
I RealtimeVoiceManager: 🎤 [DEBUG] startRecording() 被调用
I RealtimeVoiceManager: 📱 [DEBUG] 检查权限...
I RealtimeVoiceManager: 🎙️ [DEBUG] 创建 AudioRecord...
I RealtimeVoiceManager: ▶️ [DEBUG] 启动录音...
I RealtimeVoiceManager: ✅ [DEBUG] 录音已启动，开始读取数据...
I RealtimeVoiceManager: 📊 [DEBUG] 读取音频: 4096 bytes
I RealtimeVoiceManager: 📤 [DEBUG] 准备发送音频到服务器...
I RealtimeVoiceManager: 📡 [DEBUG] 发送音频: 4096 bytes
I RealtimeVoiceManager: 📊 [DEBUG] 读取音频: 4096 bytes
I RealtimeVoiceManager: 📤 [DEBUG] 准备发送音频到服务器...
...
```

### 后端日志（正常流程）

```
🔗 客户端已连接: A1B2C3D4
✅ 用户加入会话: test-session-1234567890
🎤 收到音频数据 (Session: test-session-1234567890, Size: 4096 bytes)
📝 进行ASR识别...
✅ ASR识别结果: 你好，我想应聘软件工程师
🤖 调用LLM生成回复...
✅ LLM回复: 你好！很高兴认识你。请先做一个简单的自我介绍吧。
🔊 进行TTS合成...
✅ TTS合成完成: http://localhost:3001/uploads/audio/xxxxx.mp3
```

---

## 🛠️ 临时调试方案

### 方案 1: 使用 Web 测试页面先测试后端

```bash
# 1. 确保后端启动
cd backend-api
npm run dev

# 2. 打开浏览器
open http://localhost:3001/test/digital-human

# 3. 点击"连接服务" → "开始录音"
# 看是否能正常工作
```

这样可以排除是 Android 端问题还是后端问题。

### 方案 2: 使用 curl 测试文本输入

```bash
# 测试后端是否能正常处理
curl -X POST http://localhost:3001/api/digital-human/chat \
  -H "Content-Type: application/json" \
  -d '{
    "sessionId": "test-123",
    "text": "你好",
    "userId": "test-user"
  }'
```

应该返回：
```json
{
  "success": true,
  "text": "你好！很高兴认识你...",
  "audioUrl": "http://localhost:3001/uploads/audio/xxxxx.mp3"
}
```

---

## 📝 收集诊断信息

如果还是不行，请收集以下信息：

### 1. 后端日志
```bash
cd backend-api
npm run dev 2>&1 | tee backend.log
```

### 2. Android 日志
```bash
adb logcat -v time > android.log
```

### 3. 网络测试
```bash
# 从手机访问（在手机浏览器）
http://你的电脑IP:3001/health

# 应该返回 {"status":"OK",...}
```

### 4. 环境配置
```bash
# 显示配置（隐藏密钥）
cd backend-api
source .env
echo "DeepSeek: ${DEEPSEEK_API_KEY:0:10}..."
echo "TTS ID: ${ALIYUN_TTS_ACCESS_KEY_ID:0:10}..."
echo "ASR App: $VOLC_APP_ID"
```

---

## 🎯 最可能的原因

根据你的描述 "说话没有反馈，没有日志"，最可能是：

### 1️⃣ WebSocket 未连接（最常见）
- 检查 IP 地址配置
- 确保手机和电脑在同一网络

### 2️⃣ 麦克风权限未授予
- 检查应用权限设置

### 3️⃣ 没有配置 ASR 服务
- 后端收到音频但无法识别
- 需要配置火山引擎 ASR

### 4️⃣ 后端未启动
- 检查 `lsof -i :3001`

---

## 🚀 快速修复步骤

```bash
# 1. 重启后端（确保启动）
cd backend-api
npm run dev

# 2. 查看实时日志
# 另开一个终端
adb logcat -c  # 清空旧日志
adb logcat | grep -E "Realtime|Digital|WebSocket|录音"

# 3. 在应用中操作
# - 点击"开始答题"
# - 说话 2-3 秒
# - 看日志输出

# 4. 如果没有任何日志
# 说明录音根本没有启动，检查权限和连接状态
```

---

## 💡 需要立即帮助？

把以下信息发给我：

1. **后端启动日志**（前 20 行）
2. **Android logcat 输出**
3. **AppConfig.kt 中的 WebSocket URL**
4. **是否配置了 ASR 服务**

我会帮你精准定位问题！

---

**先按照这个指南检查，告诉我在哪一步卡住了！** 🔍

