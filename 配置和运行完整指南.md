# 配置和运行完整指南

## 📋 需要配置的内容

### 1. 后端环境变量（必需）

**文件位置**：`backend-api/.env`

#### 必需配置

```bash
# ========================================
# RTC+ASR服务配置（新增 - 必需）
# ========================================

# 方案A：火山引擎（推荐）
RTC_PROVIDER=volcengine
RTC_APP_ID=your_volcengine_app_id        # 从火山引擎获取
RTC_APP_KEY=your_volcengine_app_key      # 从火山引擎获取
RTC_REGION=cn-north-1

# 方案B：声网（备选）
# RTC_PROVIDER=agora
# RTC_APP_ID=your_agora_app_id
# RTC_APP_KEY=your_agora_app_key
# RTC_TOKEN=your_agora_token

# ========================================
# 您现有的配置（检查是否已配置）
# ========================================

# DeepSeek LLM（必需）
DEEPSEEK_API_KEY=your_deepseek_api_key
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# 阿里云TTS（必需）
ALIYUN_TTS_ACCESS_KEY_ID=your_aliyun_access_key_id
ALIYUN_TTS_ACCESS_KEY_SECRET=your_aliyun_access_key_secret
ALIYUN_TTS_REGION=cn-shanghai
ALIYUN_TTS_VOICE=siqi
TTS_PROVIDER=aliyun

# 服务器配置
PORT=3001
NODE_ENV=development
```

#### 快速配置步骤

```bash
# 1. 进入后端目录
cd backend-api

# 2. 复制环境变量模板（如果.env不存在）
cp env.example .env

# 3. 编辑.env文件，添加上述配置
# 使用您喜欢的编辑器：vim .env 或 nano .env
```

---

## 🚀 需要运行的服务

### 服务列表

| 服务 | 端口 | 必需性 | 启动命令 |
|------|------|--------|----------|
| **后端API服务** | 3001 | ✅ **必需** | `cd backend-api && npm run dev` |
| **数据库** | 3306 | ⚠️ 可选 | 如果使用数据库功能 |
| **Redis** | 6379 | ⚠️ 可选 | 如果使用队列功能 |

### 快速启动（一条命令）

```bash
# 在项目根目录运行
cd backend-api && npm run dev
```

**或使用检查脚本**：

```bash
# 运行检查脚本（会自动检查配置和启动服务）
./check-services.sh
```

---

## 📝 配置详细说明

### 配置1：RTC服务（必需）

#### 选项A：火山引擎（推荐）

1. **注册账号**
   - 访问：https://www.volcengine.com/product/veRTC
   - 注册/登录火山引擎账号

2. **创建应用**
   - 进入控制台 → 实时音视频 → 创建应用
   - 获取 `AppID` 和 `AppKey`

3. **配置环境变量**
   ```bash
   RTC_PROVIDER=volcengine
   RTC_APP_ID=你的AppID
   RTC_APP_KEY=你的AppKey
   RTC_REGION=cn-north-1
   ```

#### 选项B：声网

1. **注册账号**
   - 访问：https://www.agora.io/
   - 注册/登录声网账号

2. **创建项目**
   - 进入控制台 → 创建项目
   - 获取 `AppID` 和 `App Certificate`

3. **生成Token**
   - 使用声网Token生成器生成临时Token

4. **配置环境变量**
   ```bash
   RTC_PROVIDER=agora
   RTC_APP_ID=你的AppID
   RTC_APP_KEY=你的AppCertificate
   RTC_TOKEN=你的Token
   ```

### 配置2：DeepSeek LLM（必需）

1. **获取API Key**
   - 访问：https://platform.deepseek.com/api_keys
   - 创建API Key

2. **配置环境变量**
   ```bash
   DEEPSEEK_API_KEY="<your-deepseek-api-key>"
   ```

### 配置3：阿里云TTS（必需）

1. **获取AccessKey**
   - 访问：https://ram.console.aliyun.com/
   - 创建RAM用户，获取AccessKey ID和Secret

2. **授权**
   - 添加权限：`AliyunNlsFullAccess`

3. **配置环境变量**
   ```bash
   ALIYUN_TTS_ACCESS_KEY_ID=你的AccessKeyID
   ALIYUN_TTS_ACCESS_KEY_SECRET=你的AccessKeySecret
   ALIYUN_TTS_REGION=cn-shanghai
   ALIYUN_TTS_VOICE=siqi
   TTS_PROVIDER=aliyun
   ```

---

## ✅ 快速检查清单

### 配置检查

运行检查脚本：

```bash
./check-services.sh
```

或手动检查：

```bash
# 1. 检查.env文件是否存在
ls backend-api/.env

# 2. 检查关键配置
cd backend-api
grep -E "RTC_PROVIDER|DEEPSEEK_API_KEY|ALIYUN_TTS_ACCESS_KEY_ID" .env

# 3. 检查服务是否运行
curl http://localhost:3001/health
```

### 启动服务

```bash
# 方式1：使用检查脚本（推荐）
./check-services.sh

# 方式2：手动启动
cd backend-api
npm run dev
```

---

## 🎯 最小化配置（快速测试）

如果暂时不想配置RTC服务，可以使用**模拟模式**：

```bash
# backend-api/.env
# 不配置RTC服务（系统会自动使用模拟模式）

# 只配置必需的LLM和TTS
DEEPSEEK_API_KEY=your_key
ALIYUN_TTS_ACCESS_KEY_ID=your_key
ALIYUN_TTS_ACCESS_KEY_SECRET=your_secret
```

**注意**：模拟模式下ASR会返回模拟文本，但可以测试完整流程。

---

## 📊 服务状态检查

### 检查后端服务

```bash
# 健康检查
curl http://localhost:3001/health

# 预期输出：
# {"status":"OK","timestamp":"...","version":"1.0.0"}
```

### 检查WebSocket服务

```bash
# 查看后端日志，应该看到：
# ✅ 实时语音服务初始化成功
# 🎤 实时语音WebSocket服务: ws://localhost:3001
```

### 检查配置

```bash
# 查看后端启动日志
# 如果看到：
# ✅ 实时语音服务初始化成功
#    → 配置正确

# 如果看到：
# ⚠️  RTC服务未配置，将使用模拟模式
#    → RTC服务未配置（可以使用模拟模式）

# 如果看到：
# ⚠️  TTS服务未配置
#    → TTS配置缺失
```

---

## 🔧 完整配置示例

### backend-api/.env（完整版）

```bash
# ========================================
# 服务器配置
# ========================================
PORT=3001
NODE_ENV=development

# ========================================
# RTC+ASR服务配置（新增）
# ========================================
RTC_PROVIDER=volcengine
RTC_APP_ID=your_volcengine_app_id
RTC_APP_KEY=your_volcengine_app_key
RTC_REGION=cn-north-1

# ========================================
# DeepSeek LLM配置
# ========================================
DEEPSEEK_API_KEY="<your-deepseek-api-key>"
DEEPSEEK_API_URL=https://api.deepseek.com/v1/chat/completions
DEEPSEEK_MODEL=deepseek-chat

# ========================================
# 阿里云TTS配置
# ========================================
TTS_PROVIDER=aliyun
ALIYUN_TTS_ACCESS_KEY_ID=your_aliyun_key_id
ALIYUN_TTS_ACCESS_KEY_SECRET=your_aliyun_key_secret
ALIYUN_TTS_REGION=cn-shanghai
ALIYUN_TTS_VOICE=siqi
ALIYUN_TTS_FORMAT=mp3
ALIYUN_TTS_SAMPLE_RATE=16000

# ========================================
# 数据库配置（如果使用）
# ========================================
# DATABASE_URL=mysql://user:password@localhost:3306/ai_interview_db

# ========================================
# Redis配置（如果使用）
# ========================================
# REDIS_URL=redis://localhost:6379
```

---

## 🚀 启动步骤总结

### 步骤1：配置环境变量

```bash
cd backend-api
cp env.example .env  # 如果.env不存在
# 编辑.env文件，添加配置
```

### 步骤2：安装依赖（如果还没安装）

```bash
cd backend-api
npm install
```

### 步骤3：启动服务

```bash
npm run dev
```

### 步骤4：检查服务状态

```bash
# 打开浏览器访问
http://localhost:3001/health

# 或使用curl
curl http://localhost:3001/health
```

---

## 📱 Android端配置

### 1. 添加依赖

在 `android-v0-compose/app/build.gradle.kts` 中添加：

```kotlin
dependencies {
    // Socket.IO客户端
    implementation("io.socket:socket.io-client:2.0.1")
}
```

### 2. 配置服务器地址

在 `DigitalInterviewScreen.kt` 中设置：

```kotlin
// 开发环境（使用您的电脑IP地址，不要用localhost）
val serverUrl = "http://192.168.1.100:3001"

// 生产环境
val serverUrl = "https://your-domain.com"
```

### 3. 添加权限

在 `AndroidManifest.xml` 中确保有：

```xml
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.INTERNET" />
```

---

## ✅ 快速验证

### 1. 后端服务验证

```bash
# 启动服务
cd backend-api && npm run dev

# 应该看到：
# ✅ 实时语音服务初始化成功
# 🎤 实时语音WebSocket服务: ws://localhost:3001
```

### 2. WebSocket连接测试

```bash
# 使用wscat测试（需要安装：npm install -g wscat）
wscat -c ws://localhost:3001

# 连接成功后，发送：
{"event":"join_session","data":{"sessionId":"test-123"}}
```

### 3. Android端验证

- 运行Android应用
- 查看Logcat日志（搜索 `RealtimeVoiceManager`）
- 应该看到：`✅ WebSocket连接成功`

---

## 🔍 问题排查

### Q1: 后端服务启动失败

**检查**：
```bash
# 1. 检查端口是否被占用
lsof -i :3001

# 2. 检查依赖是否安装
cd backend-api
ls node_modules

# 3. 查看错误日志
npm run dev
```

### Q2: RTC服务未初始化

**检查**：
- `.env`文件中是否配置了`RTC_APP_ID`和`RTC_APP_KEY`
- 查看后端日志，确认配置是否正确读取

### Q3: Android端无法连接

**检查**：
1. 服务器地址是否正确（不要用localhost，用IP地址）
2. 防火墙是否允许3001端口
3. 网络是否连通：`ping 服务器IP`

---

## 📚 相关文档

- `混合模式实现完成.md` - 完整实现说明
- `集成示例.md` - 集成示例代码
- `快速开始指南.md` - 快速开始步骤
- `配置和运行指南.md` - 详细配置说明

---

## 🎯 总结

### 必需配置
1. ✅ RTC服务API密钥（火山引擎或声网）
2. ✅ DeepSeek API密钥
3. ✅ 阿里云TTS AccessKey

### 必需运行的服务
1. ✅ **后端API服务**（端口3001）

### 可选服务
- ⚠️ 数据库（如果使用数据库功能）
- ⚠️ Redis（如果使用队列功能）

**只需要运行一个服务：后端API服务！** 🎉

