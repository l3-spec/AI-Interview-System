# 🏗️ 系统架构说明

## ✅ 你的理解完全正确！

---

## 🎯 一、服务都在 backend-api

**是的！所有后端服务都在 `backend-api` 目录下：**

```
backend-api/
├── src/
│   ├── index.ts                        # 🔥 主入口（启动这个就够了）
│   ├── websocket/                      # WebSocket 服务
│   │   ├── realtime-voice.websocket.ts # 实时语音 WebSocket
│   │   └── fay.websocket.ts            # Fay 数字人 WebSocket
│   ├── services/                       # 核心服务
│   │   ├── deepseekService.ts          # DeepSeek AI 服务
│   │   ├── ttsService.ts               # TTS 语音合成
│   │   ├── rtc-asr.service.ts          # ASR 语音识别
│   │   └── realtime-voice-pipeline.ts  # 语音处理管道
│   ├── routes/                         # API 路由
│   └── middleware/                     # 中间件
└── package.json                        # 依赖配置
```

---

## 🚀 二、一个命令启动所有服务

**是的！只需要一个命令：**

```bash
cd backend-api
npm run dev
```

### 这个命令会启动：

✅ **HTTP/Express 服务器** (端口 3001)  
✅ **WebSocket 服务器** (同端口，复用 HTTP)  
   - 实时语音 WebSocket  
   - Fay 数字人 WebSocket  
✅ **所有 API 路由**  
   - `/api/*` - REST API  
   - `/api/fay/*` - Fay 数字人 API  
✅ **静态文件服务**  
   - `/uploads` - 音频文件  
   - `/fay` - 数字人前端页面  
   - `/test/digital-human` - 测试页面  

### 启动日志示例：

```bash
$ npm run dev

> ai-interview-backend@1.0.0 dev
> nodemon --exec ts-node src/index.ts

✅ TTS服务已配置 (aliyun)，将使用真实服务
✅ DeepSeek服务已初始化
⚠️  RTC服务未配置，将使用模拟模式（文本输入模式）
✅ 实时语音WebSocket服务已启动
✅ FayWebSocket服务已启动
🚀 Server started on http://localhost:3001
📖 API文档: http://localhost:3001/api-docs
🔌 WebSocket端点: ws://localhost:3001
```

---

## 🔌 三、只需要 3 个第三方服务

**是的！就这 3 个：**

### 1️⃣ DeepSeek AI（必需）

**功能**: 生成面试官的智能对话回复

```bash
# .env 配置
DEEPSEEK_API_KEY="<your-deepseek-api-key>"
```

**调用方式**:
```typescript
// src/services/deepseekService.ts
async generateResponse(params: {
  userMessage: string;
  sessionId: string;
  context?: any;
}): Promise<string>
```

**费用**: ~¥0.001/1K tokens

---

### 2️⃣ 阿里云 TTS（必需）

**功能**: 将文本转换为语音（数字人说话）

```bash
# .env 配置
ALIYUN_TTS_ACCESS_KEY_ID=LTAI5txxxxxxxxxxxxxxxxxx
ALIYUN_TTS_ACCESS_KEY_SECRET=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
ALIYUN_TTS_VOICE=siqi
```

**调用方式**:
```typescript
// src/services/ttsService.ts
async textToSpeech(params: {
  text: string;
  sessionId?: string;
}): Promise<TTSResult>
```

**费用**: ~¥0.00125/字符

---

### 3️⃣ 火山引擎 ASR（可选）

**功能**: 将用户语音转换为文本（语音输入）

```bash
# .env 配置（可选）
VOLC_APP_ID=1234567890
VOLC_ACCESS_KEY=AKLTxxxxxxxxxxxxxxxx
VOLC_SECRET_KEY=xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

**调用方式**:
```typescript
// src/services/rtc-asr.service.ts
async recognize(
  audioBuffer: Buffer,
  sampleRate: number
): Promise<ASRResult>
```

**费用**: ~¥0.02/分钟

**说明**: 如果不配置，系统会使用"文本输入模式"，功能完全正常！

---

## 📦 四、完整的服务调用流程

### 场景 1: 文本输入模式（无 ASR）

```
用户输入文本
    ↓
WebSocket 接收
    ↓
DeepSeek 生成回复
    ↓
阿里云 TTS 合成语音
    ↓
返回音频 URL
    ↓
客户端播放
```

**代码流程**:
```typescript
// 1. WebSocket 接收文本消息
socket.on('text_message', async (data) => {
  // 2. 调用 DeepSeek
  const reply = await deepseekService.generateResponse({
    userMessage: data.text,
    sessionId: data.sessionId
  });
  
  // 3. 调用阿里云 TTS
  const ttsResult = await ttsService.textToSpeech({
    text: reply,
    sessionId: data.sessionId
  });
  
  // 4. 返回结果
  socket.emit('voice_response', {
    text: reply,
    audioUrl: ttsResult.audioUrl
  });
});
```

---

### 场景 2: 语音输入模式（有 ASR）

```
用户说话
    ↓
麦克风采集
    ↓
WebSocket 发送音频
    ↓
火山引擎 ASR 识别
    ↓
DeepSeek 生成回复
    ↓
阿里云 TTS 合成语音
    ↓
返回音频 URL
    ↓
客户端播放
```

**代码流程**:
```typescript
// 1. WebSocket 接收音频数据
socket.on('audio_data', async (data) => {
  // 2. 调用火山引擎 ASR
  const asrResult = await asrService.recognize(
    audioBuffer,
    sampleRate
  );
  
  // 3. 调用 DeepSeek
  const reply = await deepseekService.generateResponse({
    userMessage: asrResult.text,
    sessionId: data.sessionId
  });
  
  // 4. 调用阿里云 TTS
  const ttsResult = await ttsService.textToSpeech({
    text: reply,
    sessionId: data.sessionId
  });
  
  // 5. 返回结果
  socket.emit('voice_response', {
    text: reply,
    audioUrl: ttsResult.audioUrl
  });
});
```

---

## 🎯 五、启动清单

### 最小配置（推荐）

```bash
# 1. 配置环境变量
cd backend-api
cat > .env << 'EOF'
# DeepSeek
DEEPSEEK_API_KEY="<your-deepseek-api-key>"

# 阿里云 TTS
ALIYUN_TTS_ACCESS_KEY_ID=LTAI5t你的密钥
ALIYUN_TTS_ACCESS_KEY_SECRET=你的密钥
ALIYUN_TTS_VOICE=siqi

# 其他
NODE_ENV=development
PORT=3001
EOF

# 2. 安装依赖（首次）
npm install

# 3. 启动服务
npm run dev

# 完成！✨
```

---

## 📊 服务端口说明

| 服务 | 端口 | 说明 |
|------|------|------|
| **backend-api** | 3001 | 所有后端服务 |
| HTTP API | 3001 | REST API 接口 |
| WebSocket | 3001 | 实时通信（复用HTTP端口） |
| 静态文件 | 3001 | 音频、测试页面等 |

**只需要一个端口 3001！** 所有服务都在这个端口上！

---

## 🧪 测试服务

### 1. 健康检查

```bash
curl http://localhost:3001/health
```

返回:
```json
{
  "status": "OK",
  "timestamp": "2024-11-02T10:00:00.000Z",
  "version": "1.0.0"
}
```

### 2. WebSocket 测试

```bash
# 打开浏览器
http://localhost:3001/test/digital-human
```

### 3. API 文档

```bash
# 查看 Swagger API 文档
http://localhost:3001/api-docs
```

---

## 💡 常见问题

### Q1: 需要启动其他服务吗？
**A**: 不需要！只启动 `backend-api` 就够了。

### Q2: admin-dashboard 是什么？
**A**: 那是管理后台前端（React），是可选的。数字人系统不需要它。

### Q3: 数据库必需吗？
**A**: 不必需！不配置数据库，系统会用内存存储，功能完全正常。

### Q4: Redis 必需吗？
**A**: 不必需！Redis 是用于高级功能的，基础功能不需要。

### Q5: 需要安装 Python 吗？
**A**: 不需要！系统是纯 Node.js/TypeScript，不依赖 Python。

---

## 🎯 总结

### ✅ 你的理解完全正确！

1. **所有服务都在 backend-api** ✓
2. **只需要 `npm run dev` 启动** ✓
3. **第三方依赖**:
   - DeepSeek（必需）✓
   - 阿里云 TTS（必需）✓
   - 火山引擎 ASR（可选）✓

### 🚀 快速启动

```bash
cd backend-api
npm install          # 首次需要
npm run dev          # 启动服务
```

**就这么简单！** 🎉

---

## 📖 相关文档

- **最小化配置**: 见《最小化配置运行指南.md》
- **API 服务开通**: 见《API服务开通完整指南.md》
- **完整测试指南**: 见《数字人沟通测试完整指南.md》

---

**现在你已经完全理解系统架构了！直接启动测试吧！** 🚀

