#!/bin/bash

echo "ğŸš€ å¿«é€ŸéªŒè¯Live2Dè¯­éŸ³é©±åŠ¨ä¿®å¤"
echo ""

# æ£€æŸ¥è®¾å¤‡
if ! adb devices | grep -q "device$"; then
    echo "âŒ æœªæ£€æµ‹åˆ°è®¾å¤‡"
    exit 1
fi

echo "âœ… è®¾å¤‡å·²è¿æ¥"
echo ""

# å¸è½½æ—§ç‰ˆæœ¬
echo "ğŸ“¦ å¸è½½æ—§ç‰ˆæœ¬..."
adb uninstall com.xlwl.AiMian 2>/dev/null
sleep 1

# ç¼–è¯‘å®‰è£…
echo "ğŸ”¨ ç¼–è¯‘å®‰è£…..."
./gradlew assembleDebug -q
if [ $? -ne 0 ]; then
    echo "âŒ ç¼–è¯‘å¤±è´¥"
    exit 1
fi

adb install -r app/build/outputs/apk/debug/app-debug.apk
if [ $? -ne 0 ]; then
    echo "âŒ å®‰è£…å¤±è´¥"
    exit 1
fi

echo "âœ… å®‰è£…æˆåŠŸ"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ¯ éªŒè¯è¦ç‚¹"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "1ï¸âƒ£  æ¬¢è¿è¯­ä¸é‡å¤æ’­æ”¾"
echo "2ï¸âƒ£  Live2Då˜´å‹éšè¯­éŸ³å˜åŒ– â† æ ¸å¿ƒ"
echo "3ï¸âƒ£  æ— TTS 400é”™è¯¯ï¼ˆæˆ–è‡ªåŠ¨é‡è¯•ï¼‰"
echo "4ï¸âƒ£  è¿ç»­å¯¹è¯å˜´å‹éƒ½æ­£å¸¸"
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ğŸ“Š å…³é”®æ—¥å¿—ç›‘æ§"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# æ¸…é™¤æ—¥å¿—
adb logcat -c
sleep 1

# ç›‘æ§å…³é”®æ—¥å¿—
adb logcat | grep -E "RealtimeVoiceManager|Visualizer|Live2DRenderer" --color=always | while read line; do
    # é«˜äº®å…³é”®æˆåŠŸæ ‡å¿—
    if echo "$line" | grep -q "VisualizeréªŒè¯é€šè¿‡"; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… å…³é”®æˆåŠŸï¼šVisualizerå·²å°±ç»ª"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    elif echo "$line" | grep -q "Live2Då˜´å‹æ›´æ–°"; then
        # åªæ‰“å°éƒ¨åˆ†å˜´å‹æ›´æ–°æ—¥å¿—ï¼Œé¿å…åˆ·å±
        if [ $((RANDOM % 20)) -eq 0 ]; then
            echo "ğŸ‘„ Live2Då˜´å‹æ­£åœ¨æ›´æ–°..."
        fi
    elif echo "$line" | grep -q "å»¶è¿Ÿåçš„audioSessionId"; then
        echo "$line"
        if echo "$line" | grep -q "=0"; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ é”™è¯¯ï¼šaudioSessionIdä¸º0ï¼ŒLive2Dé©±åŠ¨å°†å¤±è´¥"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
    elif echo "$line" | grep -q "audioSessionIdä¸º0"; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš ï¸ è­¦å‘Šï¼šaudioSessionIdä¸º0"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "$line"
    elif echo "$line" | grep -q "TTSè¿”å›400é”™è¯¯"; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âš ï¸ TTS 400é”™è¯¯ï¼Œæ­£åœ¨è‡ªåŠ¨é‡è¯•..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    elif echo "$line" | grep -q "TTSæˆåŠŸ"; then
        echo "$line"
    else
        echo "$line"
    fi
done

