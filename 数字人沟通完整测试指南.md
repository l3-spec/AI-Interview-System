# 数字人沟通完整测试指南

## 📋 概述

本指南将帮助您完成整个数字人语音交互系统的端到端测试，包括：
- ✅ 后端WebSocket服务测试
- ✅ Android客户端集成测试
- ✅ Live2D数字人动画测试
- ✅ 完整的对话流程测试

---

## 🚀 第一步：后端服务启动

### 1.1 启动后端API服务

```bash
cd backend-api
npm install  # 首次运行需要安装依赖
npm run dev  # 启动开发服务器
```

**预期输出：**
```
🚀 Backend API服务已启动在端口: 3000
✅ WebSocket服务已初始化
✅ 实时语音WebSocket已就绪
```

### 1.2 验证服务状态

访问健康检查端点：
```bash
curl http://localhost:3000/api/health
```

**预期响应：**
```json
{
  "status": "ok",
  "timestamp": "2024-11-02T10:30:00.000Z",
  "services": {
    "database": "connected",
    "websocket": "running"
  }
}
```

---

## 🧪 第二步：后端WebSocket测试

### 2.1 运行自动化测试脚本

使用我们提供的测试脚本：

```bash
# 安装socket.io-client（如果还没有）
npm install socket.io-client

# 运行测试
node test-digital-human-complete.js
```

### 2.2 使用真实音频文件测试（可选）

如果您有测试音频文件（16kHz, 16-bit PCM），可以这样运行：

```bash
node test-digital-human-complete.js /path/to/your/audio.wav
```

### 2.3 预期测试结果

成功的测试输出应该如下：

```
🚀 数字人语音交互完整测试
============================================================
服务器地址: http://localhost:3000
会话ID: test-session-1730544600000
职位: Node.js后端工程师
============================================================

⏳ 正在连接WebSocket服务器...
✅ WebSocket连接成功
   Socket ID: abc123xyz

📝 加入会话...
✅ 会话加入成功
   Session ID: test-session-1730544600000

🎤 发送测试音频...
   发送音频块 1/3 (xxx 字符)
   发送音频块 2/3 (xxx 字符)
   发送音频块 3/3 (xxx 字符, FINAL)
✅ 音频发送完成

📝 收到临时识别结果:
   文本: "你好"
   Session ID: test-session-1730544600000

🎉 收到语音响应:
   文本: "你好！很高兴认识你。请简单介绍一下你自己。"
   音频URL: http://localhost:3000/uploads/tts/xxx.mp3
   Session ID: test-session-1730544600000
   时长: 2500ms

============================================================
📊 测试总结
============================================================
总耗时: 3200ms (3.20秒)

测试项目:
  ✓ WebSocket连接: ✅ 成功
  ✓ 会话加入: ✅ 成功
  ✓ 音频发送: ✅ 成功
  ✓ 临时识别结果: ✅ 成功
  ✓ 语音响应: ✅ 成功
============================================================
🎉 测试通过！数字人语音交互流程正常工作。
============================================================
```

---

## 📱 第三步：Android客户端测试

### 3.1 配置服务器地址

编辑 `android-v0-compose/app/src/main/java/com/example/v0clone/config/AppConfig.kt`:

```kotlin
object AppConfig {
    // 实时语音WebSocket服务地址
    val realtimeVoiceWsUrl = "http://10.0.2.2:3000"  // Android模拟器
    // 或者使用真实设备IP
    // val realtimeVoiceWsUrl = "http://192.168.1.100:3000"
}
```

**获取本机IP地址：**

macOS/Linux:
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

Windows:
```bash
ipconfig
```

### 3.2 构建并运行Android应用

#### 使用Android Studio:

1. 打开项目：`android-v0-compose`
2. 同步Gradle依赖
3. 选择设备（模拟器或真机）
4. 点击运行按钮 ▶️

#### 使用命令行:

```bash
cd android-v0-compose
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

### 3.3 应用内测试流程

1. **启动应用**
   - 打开AI面试系统应用
   - 登录或使用游客模式

2. **进入数字人面试**
   - 选择一个职位
   - 点击"开始面试"
   - 选择"数字人面试"模式

3. **权限授予**
   - 允许摄像头权限（用于画面预览）
   - 允许麦克风权限（必需）

4. **等待连接**
   - 观察界面底部的连接状态
   - 应显示："Live2D 数字人在线"
   - 连接指示灯应为绿色闪烁

5. **开始对话**
   - 点击"开始答题"按钮
   - 按钮变为"结束回答"
   - 对话框显示"正在聆听，请开始说话…"

6. **说话测试**
   - 对着麦克风说话：例如"你好，我叫张三"
   - 观察临时识别结果实时显示
   - 松开按钮后等待数字人回复

7. **观察数字人响应**
   - 数字人开始说话（音频播放）
   - Live2D角色嘴型同步动画
   - 对话文本显示在对话框中

---

## 🎭 第四步：Live2D动画验证

### 4.1 检查Live2D加载

**预期界面元素：**
- 主画面显示Live2D数字人角色（Hiyori模型）
- 底部显示"Live2D 数字人在线"
- 绿色指示灯闪烁

**如果Live2D未加载：**
- 检查是否显示占位画面（紫色渐变背景）
- 查看Logcat日志：`adb logcat -s Live2DView`
- 确认模型文件存在于`assets/live2d/hiyori/`

### 4.2 检查嘴型同步

**测试步骤：**
1. 数字人开始说话时
2. 观察角色嘴部动作
3. 嘴型应随音频节奏开合

**调试嘴型同步：**

查看实时日志：
```bash
adb logcat -s RealtimeVoiceManager Live2DViewController
```

**预期日志输出：**
```
D/RealtimeVoiceManager: 播放音频: http://...
D/RealtimeVoiceManager: 设置音频可视化器
D/RealtimeVoiceManager: 更新Live2D嘴型: openness=0.65
D/Live2DViewController: 设置参数: ParamMouthOpenY = 0.65
```

### 4.3 嘴型参数调优

如果嘴型动作不自然，可以调整参数：

编辑 `RealtimeVoiceManager.kt` 的 `updateLive2DMouth` 方法：

```kotlin
// 调整放大系数（默认3.0）
val mouthOpenness = (rms * 5.0f).coerceIn(0f, 1f)  // 增大幅度

// 或者降低灵敏度
val mouthOpenness = (rms * 1.5f).coerceIn(0f, 1f)  // 减小幅度
```

---

## 🔍 第五步：完整对话流程测试

### 5.1 标准对话测试案例

| 场景 | 用户输入 | 预期数字人回复 | 预期时间 |
|------|---------|--------------|---------|
| 打招呼 | "你好" | "你好！很高兴认识你..." | < 3秒 |
| 自我介绍 | "我叫张三，..." | "很高兴认识你，张三..." | < 5秒 |
| 技术问题 | "什么是闭包？" | "闭包是..." | < 5秒 |
| 项目经验 | "我做过一个电商项目..." | "能详细介绍一下..." | < 5秒 |

### 5.2 打断测试

**测试步骤：**
1. 数字人开始长回答
2. 在数字人说话过程中点击"开始答题"
3. 立即开始说话

**预期行为：**
- 数字人立即停止说话
- 嘴型动画停止
- 开始录制用户语音

**验证日志：**
```bash
adb logcat -s RealtimeVoiceManager | grep "打断"
```

### 5.3 性能指标

| 指标 | 目标值 | 测量方法 |
|------|-------|---------|
| 连接延迟 | < 1秒 | 从启动到"连接成功" |
| ASR延迟 | < 1秒 | 停止说话到识别结果 |
| LLM延迟 | < 2秒 | 识别结果到开始TTS |
| TTS延迟 | < 2秒 | LLM回复到音频开始播放 |
| 总往返时间 | < 5秒 | 停止说话到数字人开始回答 |

---

## 🐛 第六步：常见问题排查

### 6.1 WebSocket连接失败

**症状：**
- 显示"语音服务连接中..."持续不变
- 无法点击"开始答题"按钮

**排查步骤：**

1. 检查后端服务是否运行：
```bash
curl http://localhost:3000/api/health
```

2. 检查防火墙设置：
```bash
# macOS
sudo pfctl -sr | grep 3000

# Linux
sudo iptables -L | grep 3000
```

3. 检查网络连接（真机测试）：
```bash
# 从Android设备ping服务器
adb shell ping -c 4 192.168.1.100
```

4. 查看服务器日志：
```bash
# backend-api日志
tail -f backend-api/logs/*.log
```

### 6.2 音频无声或失真

**排查步骤：**

1. 检查TTS服务配置：
```bash
# 编辑backend-api/.env
AZURE_TTS_KEY=your-key
AZURE_TTS_REGION=your-region
```

2. 测试TTS服务：
```bash
curl -X POST http://localhost:3000/api/tts/synthesize \
  -H "Content-Type: application/json" \
  -d '{"text": "测试语音合成"}'
```

3. 检查音频URL可访问性：
```bash
# 从Android设备访问
adb shell curl -I http://192.168.1.100:3000/uploads/tts/xxx.mp3
```

### 6.3 Live2D模型不显示

**排查步骤：**

1. 检查模型文件：
```bash
cd android-v0-compose/app/src/main/assets/live2d/hiyori
ls -lh
# 应该看到: hiyori.model3.json, *.moc3, *.motion3.json 等
```

2. 检查OpenGL ES支持：
```bash
adb shell dumpsys | grep "GLES version"
# 应该显示: GLES version 3.0 或更高
```

3. 查看Live2D日志：
```bash
adb logcat -s Live2DView Live2DGLView Live2DRenderer | grep -i error
```

### 6.4 ASR识别准确率低

**优化建议：**

1. 调整VAD阈值（`backend-api/src/services/rtc-asr.service.ts`）：
```typescript
const vadThreshold = 0.3; // 降低阈值增加灵敏度
```

2. 增加录音时长：
```kotlin
// android-v0-compose/...RealtimeVoiceManager.kt
if (currentTime - lastSendTime >= 1000) {  // 从500ms改为1000ms
    sendAudioChunk(audioChunks.toTypedArray(), isFinal = false)
    ...
}
```

3. 检查麦克风质量：
```bash
# 录制测试音频
adb shell am start -a android.provider.MediaStore.RECORD_SOUND
# 播放并检查质量
```

---

## ✅ 第七步：验收标准

### 7.1 功能完整性

- [ ] WebSocket连接稳定
- [ ] 音频录制正常
- [ ] ASR识别准确（准确率 > 80%）
- [ ] LLM回复自然且相关
- [ ] TTS语音清晰流畅
- [ ] Live2D模型正常显示
- [ ] 嘴型动画同步
- [ ] 打断机制工作正常

### 7.2 性能指标

- [ ] 连接延迟 < 1秒
- [ ] 往返响应时间 < 5秒
- [ ] 音频播放无卡顿
- [ ] CPU使用率 < 50%
- [ ] 内存占用 < 200MB

### 7.3 用户体验

- [ ] 界面操作流畅
- [ ] 状态提示清晰
- [ ] 错误处理友好
- [ ] 没有明显的延迟感
- [ ] 数字人动作自然

---

## 📊 第八步：性能监控

### 8.1 实时日志监控

**监控Android端：**
```bash
# 完整日志
adb logcat -s RealtimeVoiceManager Live2DViewController DigitalInterviewScreen

# 仅错误
adb logcat *:E | grep -E "Realtime|Live2D|Digital"
```

**监控后端：**
```bash
# 实时日志
tail -f backend-api/logs/backend.log

# 错误日志
tail -f backend-api/logs/backend.log | grep ERROR
```

### 8.2 性能分析

**Android性能分析：**
```bash
# CPU使用率
adb shell top -n 1 | grep com.xlwl.AiMian

# 内存使用
adb shell dumpsys meminfo com.xlwl.AiMian

# 网络流量
adb shell dumpsys netstats | grep com.xlwl.AiMian
```

**后端性能监控：**
```bash
# Node.js进程监控
pm2 monit

# 内存和CPU
top -p $(pgrep -f "node.*backend-api")
```

---

## 🎯 第九步：测试场景清单

### 基本功能测试
- [ ] 首次连接成功
- [ ] 发送第一条消息
- [ ] 接收数字人回复
- [ ] 连续多轮对话
- [ ] 断线重连

### 边界情况测试
- [ ] 极短语音（< 0.5秒）
- [ ] 极长语音（> 30秒）
- [ ] 静音输入
- [ ] 噪音环境
- [ ] 网络波动

### 并发测试
- [ ] 快速连续点击"开始答题"
- [ ] 在数字人说话时快速打断
- [ ] 同时多个会话（多设备）

### 异常处理测试
- [ ] 后端服务停止
- [ ] 网络突然断开
- [ ] 麦克风权限被撤销
- [ ] 存储空间不足

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试日期**：2024-11-02  
**测试人员**：张三  
**测试环境**：
- 设备：Pixel 6 Pro
- Android版本：14
- 后端服务器：本地 (localhost:3000)

### 测试结果

| 测试项 | 结果 | 备注 |
|-------|-----|------|
| WebSocket连接 | ✅ 通过 | 连接时间约500ms |
| 音频录制 | ✅ 通过 | 清晰无噪音 |
| ASR识别 | ✅ 通过 | 准确率约85% |
| LLM回复 | ✅ 通过 | 回复相关且自然 |
| TTS合成 | ✅ 通过 | 声音清晰流畅 |
| Live2D显示 | ✅ 通过 | 模型正常渲染 |
| 嘴型同步 | ⚠️  部分通过 | 偶尔延迟约100ms |
| 打断机制 | ✅ 通过 | 响应及时 |

### 发现的问题

1. **嘴型同步偶尔延迟**
   - 严重程度：低
   - 复现步骤：在网络较慢时更容易出现
   - 建议：优化音频可视化器的更新频率

2. **...（其他问题）**

### 总体评价

系统整体运行稳定，功能完整，用户体验良好。建议在嘴型同步方面进行优化后即可投入使用。
```

---

## 🔗 相关资源

- **项目文档**：`README.md`
- **API文档**：`http://localhost:3000/api-docs`
- **后端日志**：`backend-api/logs/`
- **Android日志**：`adb logcat`
- **问题反馈**：GitHub Issues

---

## 🆘 获取帮助

如果遇到无法解决的问题：

1. 查看项目文档和API文档
2. 检查日志文件寻找错误信息
3. 在GitHub上提交Issue
4. 联系技术支持团队

---

**祝测试顺利！🎉**

