# AI面试系统跨域问题修复总结

## 问题分析

从图片中可以看到两个主要问题：

1. **admin-dashboard** 尝试访问 `/api/auth/login/company` 但返回404错误
2. **system-admin** 尝试访问 `/api/api/admin/login` 但返回404错误

## 根本原因

1. **CORS配置不完整**：后端CORS配置没有包含前端应用的端口
2. **API路由不匹配**：前端调用的API路由在后端不存在
3. **端口配置错误**：前端配置的API地址与后端实际运行端口不匹配
4. **重复API前缀**：前端配置导致URL中出现重复的 `/api/api/` 前缀
5. **Token验证问题**：后端函数名冲突导致token验证失败

## 修复方案

### 1. 后端CORS配置修复

**文件**: `backend-api/app.py`

```python
# CORS配置
CORS(app, resources={
    r"/api/*": {
        "origins": [
            "http://localhost:3000", 
            "http://127.0.0.1:3000",
            "http://localhost:5174",  # admin-dashboard
            "http://127.0.0.1:5174",
            "http://localhost:5175",  # system-admin
            "http://127.0.0.1:5175",
            "*"
        ],
        "methods": ["GET", "POST", "PUT", "DELETE", "OPTIONS"],
        "allow_headers": ["Content-Type", "Authorization"],
        "supports_credentials": True
    }
})
```

### 2. 添加缺失的API路由

#### 企业登录路由
```python
@app.route('/api/auth/login/company', methods=['POST'])
def company_login():
    """企业登录"""
    # 使用email作为登录凭证
```

#### 管理员登录路由
```python
@app.route('/api/admin/login', methods=['POST'])
def admin_login():
    """管理员登录"""
    # 支持superadmin@aiinterview.com登录
```

#### Token验证路由
```python
@app.route('/api/auth/verify', methods=['GET'])
def verify_token():
    """验证token"""
```

#### 登出路由
```python
@app.route('/api/auth/logout', methods=['POST'])
def logout():
    """用户登出"""
```

#### 管理员仪表盘路由
```python
@app.route('/api/admin/dashboard/stats', methods=['GET'])
@login_required
def get_admin_dashboard_stats():
    """获取管理员仪表盘统计数据"""
```

#### 管理员管理路由
```python
@app.route('/api/admin/admins', methods=['GET', 'POST'])
@app.route('/api/admin/admins/<admin_id>', methods=['PATCH', 'DELETE'])
```

### 3. 前端配置修复

#### admin-dashboard配置
- **文件**: `admin-dashboard/src/config/constants.ts`
- **修复**: 将API_BASE_URL改为相对路径 `/api`，使用代理配置
- **文件**: `admin-dashboard/vite.config.ts`
- **代理配置**: 已正确配置代理到 `http://localhost:3001`

#### system-admin配置
- **文件**: `system-admin/src/config/config.ts`
- **修复**: 将API_BASE_URL改为相对路径 `/api`，使用代理配置
- **文件**: `system-admin/vite.config.ts`
- **修复**: 添加了代理配置
- **文件**: `system-admin/src/services/api.ts`
- **修复**: 移除了重复的 `/api` 前缀

### 4. 后端函数名冲突修复

**文件**: `backend-api/app.py`

```python
# 修复函数名冲突
def verify_jwt_token(token):  # 重命名JWT验证函数
    """验证JWT令牌"""
    # ...

@app.route('/api/auth/verify', methods=['GET'])
def verify_token():  # 路由函数名保持不变
    """验证token"""
    # ...
```

### 5. 测试用户创建

自动创建测试用户：
- **超级管理员**: `superadmin@aiinterview.com` / `superadmin123`
- **企业用户**: `company@example.com` / `company123`

## 启动方式

### 方式1: 一键启动所有服务
```bash
./start-all.sh
```

### 方式2: 分别启动
```bash
# 启动后端
./start-backend.sh

# 启动前端（新终端）
./start-frontend.sh
```

## 服务地址

- **后端API**: http://localhost:3001
- **管理后台**: http://localhost:5174
- **系统管理**: http://localhost:5175

## 测试账号

- **超级管理员**: `superadmin@aiinterview.com` / `superadmin123`
- **企业用户**: `company@example.com` / `company123`

## 验证修复

1. 启动所有服务
2. 访问 http://localhost:5174 测试企业登录
3. 访问 http://localhost:5175 测试管理员登录
4. 检查浏览器开发者工具Network面板，确认API调用成功
5. 运行测试脚本验证API修复：`node test-api-fix.js`

## 注意事项

1. 确保后端服务在端口3001运行
2. 确保前端服务在正确的端口运行（5174和5175）
3. 如果仍有问题，检查浏览器控制台的错误信息
4. 确保所有依赖已正确安装
5. 使用代理配置时，API调用应使用相对路径

## 技术要点

1. **CORS配置**: 必须包含所有前端应用的端口
2. **代理配置**: 前端开发服务器需要正确代理API请求
3. **路由匹配**: 前后端API路由必须完全匹配
4. **认证机制**: 使用JWT token进行身份验证
5. **错误处理**: 统一的错误响应格式
6. **函数命名**: 避免函数名与路由名冲突
7. **URL配置**: 使用代理时使用相对路径，避免重复前缀 