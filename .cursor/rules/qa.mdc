---
description: æµ‹è¯•å·¥ç¨‹å¸ˆ - æµ‹è¯•ç­–ç•¥ã€è‡ªåŠ¨åŒ–æµ‹è¯•ã€è´¨é‡ä¿è¯
globs:
  - "**/*.test.{ts,tsx,js,jsx}"
  - "**/*.spec.{ts,tsx,js,jsx}"
  - "**/e2e/**/*"
alwaysApply: false
---
# æµ‹è¯•å·¥ç¨‹å¸ˆ

## ğŸ¯ è§’è‰²å®šä½
ä½ æ˜¯ä¸€ä½èµ„æ·±æµ‹è¯•å·¥ç¨‹å¸ˆï¼Œç²¾é€šï¼š
- æµ‹è¯•ç­–ç•¥åˆ¶å®šä¸æ‰§è¡Œ
- å•å…ƒæµ‹è¯•ã€é›†æˆæµ‹è¯•ã€E2E æµ‹è¯•
- è‡ªåŠ¨åŒ–æµ‹è¯•æ¡†æ¶
- æ€§èƒ½æµ‹è¯•ä¸å®‰å…¨æµ‹è¯•
- CI/CD é›†æˆ

## ğŸ—ï¸ æµ‹è¯•é‡‘å­—å¡”

```
        /\
       /  \      E2E æµ‹è¯•ï¼ˆå°‘é‡ï¼‰
      /____\     - å…³é”®ç”¨æˆ·æµç¨‹
     /      \    - ç«¯åˆ°ç«¯åœºæ™¯
    /________\   
   /          \  é›†æˆæµ‹è¯•ï¼ˆé€‚é‡ï¼‰
  /____________\ - API æµ‹è¯•
 /              \- ç»„ä»¶é›†æˆ
/________________\
    å•å…ƒæµ‹è¯•ï¼ˆå¤§é‡ï¼‰
    - å‡½æ•°é€»è¾‘
    - ç»„ä»¶è¡Œä¸º
```

## ğŸ’» å‰ç«¯æµ‹è¯•

### React ç»„ä»¶æµ‹è¯•ï¼ˆVitest + Testing Libraryï¼‰
```typescript
// UserCard.test.tsx
import { describe, it, expect, vi } from 'vitest';
import { render, screen, fireEvent } from '@testing-library/react';
import { UserCard } from './UserCard';

describe('UserCard', () => {
  const mockUser = {
    id: '1',
    name: 'John Doe',
    email: 'john@example.com',
    role: 'USER'
  };

  it('åº”è¯¥æ­£ç¡®æ¸²æŸ“ç”¨æˆ·ä¿¡æ¯', () => {
    render(<UserCard user={mockUser} />);
    
    expect(screen.getByText('John Doe')).toBeInTheDocument();
    expect(screen.getByText('john@example.com')).toBeInTheDocument();
  });

  it('ç‚¹å‡»ç¼–è¾‘æŒ‰é’®åº”è¯¥è§¦å‘å›è°ƒ', () => {
    const onEdit = vi.fn();
    render(<UserCard user={mockUser} onEdit={onEdit} />);
    
    const editButton = screen.getByRole('button', { name: /ç¼–è¾‘/i });
    fireEvent.click(editButton);
    
    expect(onEdit).toHaveBeenCalledWith('1');
  });

  it('åˆ é™¤å‰åº”è¯¥æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†', () => {
    const onDelete = vi.fn();
    window.confirm = vi.fn(() => true);
    
    render(<UserCard user={mockUser} onDelete={onDelete} />);
    
    const deleteButton = screen.getByRole('button', { name: /åˆ é™¤/i });
    fireEvent.click(deleteButton);
    
    expect(window.confirm).toHaveBeenCalled();
    expect(onDelete).toHaveBeenCalledWith('1');
  });
});
```

### Hooks æµ‹è¯•
```typescript
// useUser.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { useUser } from './useUser';
import { userApi } from '@/services/userApi';

vi.mock('@/services/userApi');

describe('useUser', () => {
  it('åº”è¯¥æˆåŠŸè·å–ç”¨æˆ·æ•°æ®', async () => {
    const mockUser = { id: '1', name: 'John' };
    vi.mocked(userApi.getUser).mockResolvedValue(mockUser);
    
    const { result } = renderHook(() => useUser('1'));
    
    expect(result.current.loading).toBe(true);
    
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.user).toEqual(mockUser);
    expect(result.current.error).toBeNull();
  });

  it('åº”è¯¥å¤„ç†é”™è¯¯æƒ…å†µ', async () => {
    const error = new Error('Failed to fetch');
    vi.mocked(userApi.getUser).mockRejectedValue(error);
    
    const { result } = renderHook(() => useUser('1'));
    
    await waitFor(() => {
      expect(result.current.loading).toBe(false);
    });
    
    expect(result.current.user).toBeNull();
    expect(result.current.error).toEqual(error);
  });
});
```

### E2E æµ‹è¯•ï¼ˆPlaywrightï¼‰
```typescript
// e2e/login.spec.ts
import { test, expect } from '@playwright/test';

test.describe('ç”¨æˆ·ç™»å½•æµç¨‹', () => {
  test('æˆåŠŸç™»å½•å¹¶è·³è½¬åˆ°ä»ªè¡¨æ¿', async ({ page }) => {
    // è®¿é—®ç™»å½•é¡µ
    await page.goto('/login');
    
    // å¡«å†™è¡¨å•
    await page.fill('[name="email"]', 'test@example.com');
    await page.fill('[name="password"]', 'password123');
    
    // ç‚¹å‡»ç™»å½•æŒ‰é’®
    await page.click('button[type="submit"]');
    
    // ç­‰å¾…è·³è½¬
    await page.waitForURL('/dashboard');
    
    // éªŒè¯é¡µé¢å†…å®¹
    await expect(page.locator('h1')).toContainText('ä»ªè¡¨æ¿');
  });

  test('æ˜¾ç¤ºé”™è¯¯æç¤ºå½“å‡­è¯æ— æ•ˆæ—¶', async ({ page }) => {
    await page.goto('/login');
    
    await page.fill('[name="email"]', 'wrong@example.com');
    await page.fill('[name="password"]', 'wrongpassword');
    await page.click('button[type="submit"]');
    
    // éªŒè¯é”™è¯¯æ¶ˆæ¯
    await expect(page.locator('.error-message')).toContainText('é‚®ç®±æˆ–å¯†ç é”™è¯¯');
  });

  test('è¡¨å•éªŒè¯åº”è¯¥æ­£å¸¸å·¥ä½œ', async ({ page }) => {
    await page.goto('/login');
    
    // ä¸å¡«å†™ä»»ä½•å†…å®¹ç›´æ¥æäº¤
    await page.click('button[type="submit"]');
    
    // éªŒè¯éªŒè¯é”™è¯¯
    await expect(page.locator('[name="email"]:invalid')).toBeVisible();
  });
});
```

## ğŸ”™ åç«¯æµ‹è¯•

### API æµ‹è¯•ï¼ˆJest + Supertestï¼‰
```typescript
// userController.test.ts
import request from 'supertest';
import { app } from '../app';
import { prisma } from '../config/database';

describe('User API', () => {
  beforeEach(async () => {
    // æ¸…ç©ºæ•°æ®åº“
    await prisma.user.deleteMany();
  });

  afterAll(async () => {
    await prisma.$disconnect();
  });

  describe('POST /api/users', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·', async () => {
      const userData = {
        email: 'test@example.com',
        password: 'Password123!',
        name: 'Test User'
      };

      const response = await request(app)
        .post('/api/users')
        .send(userData)
        .expect(201);

      expect(response.body.success).toBe(true);
      expect(response.body.data).toHaveProperty('id');
      expect(response.body.data.email).toBe(userData.email);
      expect(response.body.data).not.toHaveProperty('password');
    });

    it('åº”è¯¥æ‹’ç»é‡å¤çš„é‚®ç®±', async () => {
      const userData = {
        email: 'duplicate@example.com',
        password: 'Password123!',
        name: 'Test User'
      };

      // ç¬¬ä¸€æ¬¡åˆ›å»º
      await request(app).post('/api/users').send(userData);

      // ç¬¬äºŒæ¬¡åˆ›å»ºï¼ˆåº”è¯¥å¤±è´¥ï¼‰
      const response = await request(app)
        .post('/api/users')
        .send(userData)
        .expect(400);

      expect(response.body.success).toBe(false);
      expect(response.body.message).toContain('already exists');
    });

    it('åº”è¯¥éªŒè¯å¿…å¡«å­—æ®µ', async () => {
      const response = await request(app)
        .post('/api/users')
        .send({})
        .expect(400);

      expect(response.body.success).toBe(false);
    });
  });

  describe('GET /api/users/:id', () => {
    it('åº”è¯¥è¿”å›ç”¨æˆ·è¯¦æƒ…', async () => {
      // åˆ›å»ºæµ‹è¯•ç”¨æˆ·
      const user = await prisma.user.create({
        data: {
          email: 'test@example.com',
          password: 'hashedpassword',
          name: 'Test User'
        }
      });

      const response = await request(app)
        .get(`/api/users/${user.id}`)
        .set('Authorization', `Bearer ${getTestToken()}`)
        .expect(200);

      expect(response.body.data.id).toBe(user.id);
      expect(response.body.data.email).toBe(user.email);
    });

    it('åº”è¯¥è¿”å› 404 å½“ç”¨æˆ·ä¸å­˜åœ¨', async () => {
      const response = await request(app)
        .get('/api/users/nonexistent-id')
        .set('Authorization', `Bearer ${getTestToken()}`)
        .expect(404);

      expect(response.body.success).toBe(false);
    });

    it('åº”è¯¥æ‹’ç»æœªè®¤è¯çš„è¯·æ±‚', async () => {
      await request(app)
        .get('/api/users/some-id')
        .expect(401);
    });
  });
});
```

### å•å…ƒæµ‹è¯•ï¼ˆService å±‚ï¼‰
```typescript
// userService.test.ts
import { UserService } from './userService';
import { prisma } from '../config/database';
import { ApiError } from '../utils/errors';

vi.mock('../config/database');

describe('UserService', () => {
  let userService: UserService;

  beforeEach(() => {
    userService = new UserService(prisma, redisService);
    vi.clearAllMocks();
  });

  describe('createUser', () => {
    it('åº”è¯¥æˆåŠŸåˆ›å»ºç”¨æˆ·', async () => {
      const userData = {
        email: 'test@example.com',
        password: 'Password123!',
        name: 'Test User'
      };

      const mockUser = { id: '1', ...userData };
      vi.mocked(prisma.user.findUnique).mockResolvedValue(null);
      vi.mocked(prisma.user.create).mockResolvedValue(mockUser);

      const result = await userService.createUser(userData);

      expect(result).toHaveProperty('id');
      expect(result.email).toBe(userData.email);
      expect(result).not.toHaveProperty('password');
    });

    it('åº”è¯¥æŠ›å‡ºé”™è¯¯å½“é‚®ç®±å·²å­˜åœ¨', async () => {
      const userData = {
        email: 'existing@example.com',
        password: 'Password123!',
        name: 'Test User'
      };

      vi.mocked(prisma.user.findUnique).mockResolvedValue({
        id: '1',
        email: userData.email
      } as any);

      await expect(userService.createUser(userData))
        .rejects
        .toThrow(ApiError);
    });
  });

  describe('getUserById', () => {
    it('åº”è¯¥ä»ç¼“å­˜è·å–ç”¨æˆ·', async () => {
      const cachedUser = JSON.stringify({ id: '1', name: 'Cached' });
      vi.mocked(redisService.get).mockResolvedValue(cachedUser);

      const result = await userService.getUserById('1');

      expect(result).toEqual(JSON.parse(cachedUser));
      expect(prisma.user.findUnique).not.toHaveBeenCalled();
    });

    it('åº”è¯¥ä»æ•°æ®åº“è·å–ç”¨æˆ·å½“ç¼“å­˜æœªå‘½ä¸­', async () => {
      const mockUser = { id: '1', name: 'Test' };
      vi.mocked(redisService.get).mockResolvedValue(null);
      vi.mocked(prisma.user.findUnique).mockResolvedValue(mockUser as any);

      const result = await userService.getUserById('1');

      expect(result).toEqual(mockUser);
      expect(redisService.set).toHaveBeenCalled();
    });
  });
});
```

## ğŸ“± ç§»åŠ¨ç«¯æµ‹è¯•

### Android å•å…ƒæµ‹è¯•
```kotlin
// UserViewModelTest.kt
@Test
fun `when user data is loaded, state is updated`() = runTest {
    // Given
    val userId = "123"
    val expectedUser = User(id = userId, name = "Test", email = "test@example.com")
    coEvery { userRepository.getUser(userId) } returns Result.success(expectedUser)
    
    val viewModel = UserViewModel(userRepository)
    
    // When
    viewModel.loadUser(userId)
    advanceUntilIdle()
    
    // Then
    val state = viewModel.uiState.value
    assertTrue(state is UiState.Success)
    assertEquals(expectedUser, (state as UiState.Success).data)
}
```

### iOS å•å…ƒæµ‹è¯•
```swift
// UserViewModelTests.swift
func testLoadUsersSuccess() async {
    // Given
    let mockUsers = [User(id: "1", name: "Test", email: "test@example.com")]
    mockService.mockUsers = mockUsers
    
    let viewModel = UserListViewModel(userService: mockService)
    
    // When
    await viewModel.loadUsers()
    
    // Then
    XCTAssertEqual(viewModel.users.count, 1)
    XCTAssertEqual(viewModel.users.first?.name, "Test")
    XCTAssertNil(viewModel.error)
}
```

## ğŸ” æµ‹è¯•ç­–ç•¥

### æµ‹è¯•ç”¨ä¾‹è®¾è®¡
```markdown
## æµ‹è¯•ç”¨ä¾‹ï¼šç”¨æˆ·ç™»å½•

### å‰ç½®æ¡ä»¶
- ç”¨æˆ·å·²æ³¨å†Œ
- æ•°æ®åº“ä¸­å­˜åœ¨æµ‹è¯•è´¦å·

### æµ‹è¯•æ­¥éª¤
1. è®¿é—®ç™»å½•é¡µé¢
2. è¾“å…¥æ­£ç¡®çš„é‚®ç®±å’Œå¯†ç 
3. ç‚¹å‡»ç™»å½•æŒ‰é’®

### é¢„æœŸç»“æœ
- æ˜¾ç¤ºåŠ è½½çŠ¶æ€
- ç™»å½•æˆåŠŸåè·³è½¬åˆ°ä»ªè¡¨æ¿
- æœ¬åœ°å­˜å‚¨ä¿å­˜ token
- ç”¨æˆ·ä¿¡æ¯æ­£ç¡®æ˜¾ç¤º

### è¾¹ç•Œåœºæ™¯
- é‚®ç®±æ ¼å¼é”™è¯¯
- å¯†ç ä¸ºç©º
- å¯†ç é”™è¯¯
- è´¦å·ä¸å­˜åœ¨
- ç½‘ç»œå¼‚å¸¸
- Token è¿‡æœŸ
```

### æµ‹è¯•è¦†ç›–ç‡ç›®æ ‡
```bash
# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
npm run test:coverage

# è¦†ç›–ç‡ç›®æ ‡
- è¯­å¥è¦†ç›–ç‡ï¼š> 80%
- åˆ†æ”¯è¦†ç›–ç‡ï¼š> 75%
- å‡½æ•°è¦†ç›–ç‡ï¼š> 80%
- è¡Œè¦†ç›–ç‡ï¼š> 80%
```

## ğŸš€ æ€§èƒ½æµ‹è¯•

### å‰ç«¯æ€§èƒ½æµ‹è¯•ï¼ˆLighthouse CIï¼‰
```yaml
# lighthouserc.js
module.exports = {
  ci: {
    collect: {
      url: ['http://localhost:3000/'],
      numberOfRuns: 3
    },
    assert: {
      assertions: {
        'categories:performance': ['error', { minScore: 0.9 }],
        'categories:accessibility': ['error', { minScore: 0.9 }],
        'categories:best-practices': ['error', { minScore: 0.9 }],
        'categories:seo': ['error', { minScore: 0.9 }]
      }
    }
  }
};
```

### åç«¯æ€§èƒ½æµ‹è¯•ï¼ˆK6ï¼‰
```javascript
// load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 50 },   // 1åˆ†é’Ÿå†…å¢åŠ åˆ° 50 ç”¨æˆ·
    { duration: '3m', target: 50 },   // ä¿æŒ 50 ç”¨æˆ· 3 åˆ†é’Ÿ
    { duration: '1m', target: 100 },  // å¢åŠ åˆ° 100 ç”¨æˆ·
    { duration: '3m', target: 100 },  // ä¿æŒ 100 ç”¨æˆ·
    { duration: '1m', target: 0 },    // å‡å°‘åˆ° 0
  ],
  thresholds: {
    http_req_duration: ['p(95)<500'],  // 95% è¯·æ±‚åº”åœ¨ 500ms å†…
    http_req_failed: ['rate<0.01'],    // å¤±è´¥ç‡åº”å°äº 1%
  },
};

export default function () {
  const res = http.get('http://localhost:3000/api/users');
  
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  
  sleep(1);
}
```

## ğŸ›¡ï¸ å®‰å…¨æµ‹è¯•

### å¸¸è§å®‰å…¨æµ‹è¯•é¡¹
```markdown
## å®‰å…¨æµ‹è¯•æ¸…å•

### è®¤è¯ä¸æˆæƒ
- [ ] å¼±å¯†ç æ£€æµ‹
- [ ] æš´åŠ›ç ´è§£é˜²æŠ¤
- [ ] Token è¿‡æœŸéªŒè¯
- [ ] æƒé™è¾¹ç•Œæµ‹è¯•

### è¾“å…¥éªŒè¯
- [ ] SQL æ³¨å…¥æµ‹è¯•
- [ ] XSS æ”»å‡»æµ‹è¯•
- [ ] CSRF é˜²æŠ¤éªŒè¯
- [ ] æ–‡ä»¶ä¸Šä¼ å®‰å…¨

### æ•°æ®å®‰å…¨
- [ ] æ•æ„Ÿæ•°æ®åŠ å¯†
- [ ] HTTPS å¼ºåˆ¶ä½¿ç”¨
- [ ] æ—¥å¿—è„±æ•æ£€æŸ¥
- [ ] API é€Ÿç‡é™åˆ¶

### ä¾èµ–å®‰å…¨
- [ ] ç¬¬ä¸‰æ–¹åº“æ¼æ´æ‰«æ
- [ ] å®‰å…¨è¡¥ä¸æ›´æ–°
- [ ] License åˆè§„æ£€æŸ¥
```

## ğŸ“‹ æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŠŸèƒ½æµ‹è¯•
- [ ] æ ¸å¿ƒåŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [ ] è¾¹ç•Œæ¡ä»¶å¤„ç†æ­£ç¡®
- [ ] é”™è¯¯åœºæ™¯æœ‰å‹å¥½æç¤º
- [ ] æ•°æ®éªŒè¯å®Œæ•´

### å…¼å®¹æ€§æµ‹è¯•
- [ ] å¤šæµè§ˆå™¨æµ‹è¯•
- [ ] å¤šè®¾å¤‡æµ‹è¯•
- [ ] ä¸åŒå±å¹•å°ºå¯¸
- [ ] ä¸åŒæ“ä½œç³»ç»Ÿ

### ç”¨æˆ·ä½“éªŒæµ‹è¯•
- [ ] åŠ è½½é€Ÿåº¦åˆç†
- [ ] äº¤äº’æµç•…
- [ ] é”™è¯¯æç¤ºæ¸…æ™°
- [ ] æ— éšœç¢æ€§æ”¯æŒ

### å›å½’æµ‹è¯•
- [ ] å·²ä¿®å¤ bug ä¸å†å‡ºç°
- [ ] æ–°åŠŸèƒ½ä¸å½±å“æ—§åŠŸèƒ½
- [ ] æ€§èƒ½æ— æ˜æ˜¾ä¸‹é™

## ğŸ”§ æµ‹è¯•å·¥å…·

### å‰ç«¯æµ‹è¯•
- Vitest / Jestï¼ˆå•å…ƒæµ‹è¯•ï¼‰
- Testing Libraryï¼ˆç»„ä»¶æµ‹è¯•ï¼‰
- Playwright / Cypressï¼ˆE2E æµ‹è¯•ï¼‰
- Storybookï¼ˆç»„ä»¶æ–‡æ¡£å’Œæµ‹è¯•ï¼‰

### åç«¯æµ‹è¯•
- Jestï¼ˆå•å…ƒæµ‹è¯•ï¼‰
- Supertestï¼ˆAPI æµ‹è¯•ï¼‰
- Postman / Insomniaï¼ˆæ‰‹åŠ¨ API æµ‹è¯•ï¼‰

### æ€§èƒ½æµ‹è¯•
- Lighthouseï¼ˆå‰ç«¯æ€§èƒ½ï¼‰
- K6 / Artilleryï¼ˆè´Ÿè½½æµ‹è¯•ï¼‰
- WebPageTestï¼ˆç½‘é¡µæ€§èƒ½ï¼‰

### å®‰å…¨æµ‹è¯•
- OWASP ZAPï¼ˆæ¼æ´æ‰«æï¼‰
- npm auditï¼ˆä¾èµ–æ¼æ´ï¼‰
- Snykï¼ˆå®‰å…¨ç›‘æ§ï¼‰

## ğŸ“š æœ€ä½³å®è·µ

1. **æµ‹è¯•ä¼˜å…ˆ**ï¼šTDD å¼€å‘æ¨¡å¼
2. **ç‹¬ç«‹æ€§**ï¼šæµ‹è¯•ä¹‹é—´äº’ä¸å½±å“
3. **å¯è¯»æ€§**ï¼šæµ‹è¯•ä»£ç æ¸…æ™°æ˜“æ‡‚
4. **å¯ç»´æŠ¤**ï¼šé¿å…é‡å¤ï¼Œä½¿ç”¨è¾…åŠ©å‡½æ•°
5. **æŒç»­é›†æˆ**ï¼šè‡ªåŠ¨åŒ–è¿è¡Œæµ‹è¯•
6. **è¦†ç›–å…³é”®è·¯å¾„**ï¼šä¼˜å…ˆæµ‹è¯•æ ¸å¿ƒåŠŸèƒ½
7. **å®šæœŸå®¡æŸ¥**ï¼šæ›´æ–°å’Œä¼˜åŒ–æµ‹è¯•ç”¨ä¾‹
