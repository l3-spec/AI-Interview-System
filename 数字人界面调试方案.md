# ğŸ” æ•°å­—äººç•Œé¢ WebSocket è¿æ¥é—®é¢˜è¯Šæ–­

> å…¶ä»–é¡µé¢ API æ­£å¸¸ï¼Œä½†æ•°å­—äººç•Œé¢ WebSocket è¿æ¥å¤±è´¥ä¸”æ— æ—¥å¿—

---

## ğŸ¯ é—®é¢˜å®šä½

åŸºäºä½ çš„æƒ…å†µï¼š
- âœ… å…¶ä»–é¡µé¢ HTTP API è°ƒç”¨æ­£å¸¸
- âœ… ç½‘ç»œè¿æ¥æ²¡é—®é¢˜
- âŒ æ•°å­—äººç•Œé¢æ˜¾ç¤º"è¯­éŸ³æœåŠ¡è¿æ¥ä¸­..."
- âŒ `adb logcat | grep RealtimeVoiceManager` å®Œå…¨æ²¡æœ‰æ—¥å¿—

**ç»“è®º**ï¼š`RealtimeVoiceManager` çš„åˆå§‹åŒ–ä»£ç æ ¹æœ¬æ²¡æœ‰æ‰§è¡Œï¼

---

## ğŸ” æ’æŸ¥å…³é”®ä»£ç 

### æ£€æŸ¥ç‚¹ 1ï¼š`voiceManager` æ˜¯å¦è¢«åˆ›å»º

åœ¨ `DigitalInterviewScreen.kt` çš„ç¬¬ 119 è¡Œï¼š

```kotlin
val voiceManager = remember { RealtimeVoiceManager(context.applicationContext) }
```

**é—®é¢˜**ï¼šè¿™è¡Œä»£ç æ‰§è¡Œäº†å—ï¼Ÿ

### æ£€æŸ¥ç‚¹ 2ï¼šåˆå§‹åŒ–æ¡ä»¶

åœ¨ç¬¬ 200-211 è¡Œï¼š

```kotlin
LaunchedEffect(uiState.sessionId, hasMicrophonePermission, connectionState) {
    if (uiState.sessionId.isNotBlank() && 
        hasMicrophonePermission && 
        connectionState == ConnectionState.DISCONNECTED) {
        
        val success = voiceManager.initialize(...)
    }
}
```

**å…³é”®æ¡ä»¶**ï¼š
1. `uiState.sessionId` ä¸ä¸ºç©º
2. `hasMicrophonePermission` ä¸º true
3. `connectionState == ConnectionState.DISCONNECTED`

**å¦‚æœä»»ä½•ä¸€ä¸ªæ¡ä»¶ä¸æ»¡è¶³ï¼Œinitialize å°±ä¸ä¼šè¢«è°ƒç”¨ï¼**

---

## ğŸš¨ æœ€å¯èƒ½çš„åŸå› 

### åŸå›  1ï¼š`sessionId` ä¸ºç©ºï¼ˆ80% å¯èƒ½ï¼‰

å¦‚æœ `uiState.sessionId` æ˜¯ç©ºçš„ï¼Œåˆå§‹åŒ–ä»£ç æ ¹æœ¬ä¸ä¼šæ‰§è¡Œï¼

**æ£€æŸ¥æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹ç•Œé¢çŠ¶æ€æ—¥å¿—
adb logcat | grep "UI State"
```

åº”è¯¥çœ‹åˆ°ï¼š
```
D DigitalInterviewScreen: UI State: isLoading=false, error=null, question=..., sessionId=xxx
```

**å¦‚æœ sessionId æ˜¯ç©ºçš„ï¼Œé‚£å°±æ˜¯é—®é¢˜ï¼**

### åŸå›  2ï¼šéº¦å…‹é£æƒé™æœªæˆäºˆï¼ˆ15% å¯èƒ½ï¼‰

å³ä½¿ä½ æˆäºˆäº†æƒé™ï¼Œä»£ç å¯èƒ½æ²¡æœ‰æ­£ç¡®æ£€æµ‹åˆ°ã€‚

**æ£€æŸ¥æ–¹æ³•**ï¼š

```bash
# æŸ¥çœ‹æƒé™æ£€æŸ¥æ—¥å¿—
adb logcat | grep "permission\|Permission"
```

### åŸå›  3ï¼š`connectionState` åˆå§‹å€¼ä¸æ˜¯ DISCONNECTEDï¼ˆ5% å¯èƒ½ï¼‰

å¦‚æœåˆå§‹çŠ¶æ€ä¸æ˜¯ `DISCONNECTED`ï¼ŒLaunchedEffect å°±ä¸ä¼šè§¦å‘ã€‚

---

## ğŸ› ï¸ ç«‹å³è¯Šæ–­æ–¹æ¡ˆ

### æ­¥éª¤ 1ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—

éœ€è¦ä¸´æ—¶ä¿®æ”¹ä»£ç æ¥çœ‹åˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆã€‚

#### ä¿®æ”¹ 1ï¼šåœ¨ `DigitalInterviewScreen.kt` ä¸­æ·»åŠ æ—¥å¿—

```kotlin
// åœ¨ç¬¬ 119 è¡Œä¹‹åæ·»åŠ 
val voiceManager = remember { 
    Log.d("DigitalInterview", "ğŸ”§ [DEBUG] åˆ›å»º RealtimeVoiceManager")
    RealtimeVoiceManager(context.applicationContext)
}

// åœ¨ç¬¬ 127-129 è¡Œä¿®æ”¹
LaunchedEffect(Unit) {
    Log.d("DigitalInterview", "ğŸ”§ [DEBUG] è®¾ç½® Live2D æ§åˆ¶å™¨")
    voiceManager.setLive2DController(live2DController)
}

// åœ¨ç¬¬ 139-142 è¡Œæ·»åŠ 
LaunchedEffect(uiState) {
    Log.d("DigitalInterview", "ğŸ”§ [DEBUG] UI State å˜åŒ–:")
    Log.d("DigitalInterview", "  - isLoading: ${uiState.isLoading}")
    Log.d("DigitalInterview", "  - sessionId: ${uiState.sessionId}")
    Log.d("DigitalInterview", "  - errorMessage: ${uiState.errorMessage}")
    Log.d("DigitalInterview", "  - questionText: ${uiState.questionText}")
}

// åœ¨ç¬¬ 200 è¡Œä¿®æ”¹ä¸º
LaunchedEffect(uiState.sessionId, hasMicrophonePermission, connectionState) {
    Log.d("DigitalInterview", "ğŸ”§ [DEBUG] LaunchedEffect è§¦å‘:")
    Log.d("DigitalInterview", "  - sessionId: '${uiState.sessionId}' (ç©º=${uiState.sessionId.isBlank()})")
    Log.d("DigitalInterview", "  - hasMicrophonePermission: $hasMicrophonePermission")
    Log.d("DigitalInterview", "  - connectionState: $connectionState")
    
    if (uiState.sessionId.isNotBlank() && 
        hasMicrophonePermission && 
        connectionState == ConnectionState.DISCONNECTED) {
        
        Log.d("DigitalInterview", "âœ… [DEBUG] æ¡ä»¶æ»¡è¶³ï¼Œå¼€å§‹åˆå§‹åŒ–...")
        val success = voiceManager.initialize(
            AppConfig.realtimeVoiceWsUrl,
            uiState.sessionId,
            jobPosition = uiState.position
        )
        Log.d("DigitalInterview", "ğŸ”§ [DEBUG] åˆå§‹åŒ–ç»“æœ: $success")
        
        if (!success) {
            Toast.makeText(context, "å®æ—¶è¯­éŸ³æœåŠ¡è¿æ¥å¤±è´¥", Toast.LENGTH_SHORT).show()
        }
    } else {
        Log.w("DigitalInterview", "âŒ [DEBUG] æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡åˆå§‹åŒ–")
        if (uiState.sessionId.isBlank()) {
            Log.w("DigitalInterview", "  åŸå› : sessionId ä¸ºç©º")
        }
        if (!hasMicrophonePermission) {
            Log.w("DigitalInterview", "  åŸå› : æ²¡æœ‰éº¦å…‹é£æƒé™")
        }
        if (connectionState != ConnectionState.DISCONNECTED) {
            Log.w("DigitalInterview", "  åŸå› : connectionState != DISCONNECTED (å½“å‰: $connectionState)")
        }
    }
}
```

#### ä¿®æ”¹ 2ï¼šåœ¨ `RealtimeVoiceManager.kt` ä¸­æ·»åŠ æ—¥å¿—

```kotlin
// åœ¨æ„é€ å‡½æ•°ä¸­æ·»åŠ 
class RealtimeVoiceManager(private val context: Context) {
    init {
        Log.d(TAG, "ğŸ¯ [DEBUG] RealtimeVoiceManager æ„é€ å‡½æ•°è¢«è°ƒç”¨")
        Log.d(TAG, "ğŸ¯ [DEBUG] Context: ${context.javaClass.simpleName}")
    }
    
    // ...
    
    fun initialize(
        wsUrl: String,
        sessionId: String,
        jobPosition: String? = null
    ): Boolean {
        Log.d(TAG, "ğŸš€ [DEBUG] initialize() è¢«è°ƒç”¨")
        Log.d(TAG, "  - wsUrl: $wsUrl")
        Log.d(TAG, "  - sessionId: $sessionId")
        Log.d(TAG, "  - jobPosition: $jobPosition")
        
        // ... åŸæœ‰ä»£ç 
    }
}
```

### æ­¥éª¤ 2ï¼šé‡æ–°ç¼–è¯‘å®‰è£…

```bash
cd android-v0-compose
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

### æ­¥éª¤ 3ï¼šæŸ¥çœ‹æ–°çš„æ—¥å¿—

```bash
# æ¸…ç©ºæ—§æ—¥å¿—
adb logcat -c

# æŸ¥çœ‹è°ƒè¯•æ—¥å¿—
adb logcat | grep "\[DEBUG\]"
```

---

## ğŸ“‹ é¢„æœŸçœ‹åˆ°çš„æ—¥å¿—

### æ­£å¸¸æƒ…å†µï¼ˆåº”è¯¥çœ‹åˆ°ï¼‰ï¼š

```
D DigitalInterview: ğŸ”§ [DEBUG] åˆ›å»º RealtimeVoiceManager
D RealtimeVoiceManager: ğŸ¯ [DEBUG] RealtimeVoiceManager æ„é€ å‡½æ•°è¢«è°ƒç”¨
D DigitalInterview: ğŸ”§ [DEBUG] è®¾ç½® Live2D æ§åˆ¶å™¨
D DigitalInterview: ğŸ”§ [DEBUG] UI State å˜åŒ–:
D DigitalInterview:   - isLoading: false
D DigitalInterview:   - sessionId: test-session-12345
D DigitalInterview:   - errorMessage: null
D DigitalInterview: ğŸ”§ [DEBUG] LaunchedEffect è§¦å‘:
D DigitalInterview:   - sessionId: 'test-session-12345' (ç©º=false)
D DigitalInterview:   - hasMicrophonePermission: true
D DigitalInterview:   - connectionState: DISCONNECTED
D DigitalInterview: âœ… [DEBUG] æ¡ä»¶æ»¡è¶³ï¼Œå¼€å§‹åˆå§‹åŒ–...
D RealtimeVoiceManager: ğŸš€ [DEBUG] initialize() è¢«è°ƒç”¨
D RealtimeVoiceManager:   - wsUrl: ws://192.168.120.124:3001
D RealtimeVoiceManager:   - sessionId: test-session-12345
```

### å¼‚å¸¸æƒ…å†µï¼ˆå¯èƒ½çœ‹åˆ°ï¼‰ï¼š

```
D DigitalInterview: ğŸ”§ [DEBUG] åˆ›å»º RealtimeVoiceManager
D RealtimeVoiceManager: ğŸ¯ [DEBUG] RealtimeVoiceManager æ„é€ å‡½æ•°è¢«è°ƒç”¨
D DigitalInterview: ğŸ”§ [DEBUG] UI State å˜åŒ–:
D DigitalInterview:   - sessionId: '' (ç©ºå­—ç¬¦ä¸²ï¼)
D DigitalInterview: âŒ [DEBUG] æ¡ä»¶ä¸æ»¡è¶³ï¼Œè·³è¿‡åˆå§‹åŒ–
D DigitalInterview:   åŸå› : sessionId ä¸ºç©º
```

---

## ğŸ¯ æ ¹æ®æ—¥å¿—è¯Šæ–­

### æƒ…å†µ 1ï¼šå®Œå…¨æ²¡æœ‰ "[DEBUG]" æ—¥å¿—

**è¯´æ˜**ï¼š`DigitalInterviewScreen` æ ¹æœ¬æ²¡æœ‰è¢«æ¸²æŸ“

**åŸå› **ï¼šå¯èƒ½æ˜¯å¯¼èˆªé—®é¢˜æˆ–é¡µé¢åŠ è½½å¤±è´¥

**æ’æŸ¥**ï¼š
```bash
adb logcat | grep "DigitalInterview\|Navigation"
```

### æƒ…å†µ 2ï¼šæœ‰ "åˆ›å»º RealtimeVoiceManager" ä½†æ²¡æœ‰ "LaunchedEffect è§¦å‘"

**è¯´æ˜**ï¼šLaunchedEffect çš„ä¾èµ–é¡¹æ²¡æœ‰å˜åŒ–ï¼Œæˆ–è€…æ¡ä»¶ä¸€ç›´ä¸æ»¡è¶³

**åŸå› **ï¼š
- `uiState.sessionId` ä¸€ç›´ä¸ºç©º
- æƒé™é—®é¢˜
- connectionState ä¸å¯¹

### æƒ…å†µ 3ï¼šæœ‰ "LaunchedEffect è§¦å‘" ä½†æ˜¾ç¤º"æ¡ä»¶ä¸æ»¡è¶³"

**è¯´æ˜**ï¼šæŸä¸ªæ¡ä»¶æ£€æŸ¥å¤±è´¥äº†

**çœ‹æ—¥å¿—ä¸­çš„åŸå› **ï¼Œç„¶åé’ˆå¯¹æ€§ä¿®å¤

### æƒ…å†µ 4ï¼šæœ‰ "æ¡ä»¶æ»¡è¶³ï¼Œå¼€å§‹åˆå§‹åŒ–" ä½†æ²¡æœ‰åç»­æ—¥å¿—

**è¯´æ˜**ï¼š`voiceManager.initialize()` å†…éƒ¨å‡ºé”™äº†

**æ’æŸ¥**ï¼šæŸ¥çœ‹ RealtimeVoiceManager çš„é”™è¯¯æ—¥å¿—

---

## ğŸ’¡ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆï¼ˆä¸æ”¹ä»£ç ï¼‰

### æ–¹æ¡ˆ 1ï¼šæ£€æŸ¥ sessionId æ˜¯ä»å“ªæ¥çš„

```bash
# æŸ¥çœ‹ç•Œé¢ä¼ å…¥çš„å‚æ•°
adb logcat | grep -i "session"
```

å¦‚æœ sessionId æ˜¯ç©ºçš„ï¼Œéœ€è¦æ£€æŸ¥ï¼š
- å¯¼èˆªå‚æ•°æ˜¯å¦æ­£ç¡®ä¼ é€’
- ViewModel æ˜¯å¦æ­£ç¡®åˆå§‹åŒ–

### æ–¹æ¡ˆ 2ï¼šå¼ºåˆ¶èµ‹å€¼ sessionIdï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰

åœ¨ `DigitalInterviewScreen.kt` ä¸­ä¸´æ—¶æ·»åŠ ï¼š

```kotlin
// åœ¨ç¬¬ 200 è¡Œä¹‹å‰æ·»åŠ ä¸´æ—¶ä»£ç 
val testSessionId = remember { "test-session-${System.currentTimeMillis()}" }

LaunchedEffect(testSessionId, hasMicrophonePermission, connectionState) {
    Log.d("DigitalInterview", "ğŸ”§ [TEST] ä½¿ç”¨æµ‹è¯• sessionId: $testSessionId")
    
    if (testSessionId.isNotBlank() && 
        hasMicrophonePermission && 
        connectionState == ConnectionState.DISCONNECTED) {
        
        val success = voiceManager.initialize(
            AppConfig.realtimeVoiceWsUrl,
            testSessionId,  // ä½¿ç”¨æµ‹è¯• sessionId
            jobPosition = uiState.position
        )
        // ...
    }
}
```

è¿™æ ·å¯ä»¥æ’é™¤ sessionId çš„é—®é¢˜ã€‚

---

## ğŸš€ ç°åœ¨è¯·æ‰§è¡Œ

### æ­¥éª¤ 1ï¼šæ·»åŠ ä¸Šé¢çš„è°ƒè¯•æ—¥å¿—

ä¿®æ”¹è¿™ä¸¤ä¸ªæ–‡ä»¶ï¼š
1. `DigitalInterviewScreen.kt` - æ·»åŠ è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—
2. `RealtimeVoiceManager.kt` - æ·»åŠ æ„é€ å’Œåˆå§‹åŒ–æ—¥å¿—

### æ­¥éª¤ 2ï¼šé‡æ–°ç¼–è¯‘å®‰è£…

```bash
cd android-v0-compose
./gradlew assembleDebug
adb install -r app/build/outputs/apk/debug/app-debug.apk
```

### æ­¥éª¤ 3ï¼šæ¸…ç©ºæ—¥å¿—å¹¶è¿è¡Œ

```bash
adb logcat -c
adb logcat | grep "\[DEBUG\]"
```

### æ­¥éª¤ 4ï¼šåœ¨åº”ç”¨ä¸­æ‰“å¼€æ•°å­—äººç•Œé¢

ç„¶åæŠŠçœ‹åˆ°çš„æ‰€æœ‰ `[DEBUG]` æ—¥å¿—å‘ç»™æˆ‘ï¼

---

## ğŸ“Œ å…³é”®ç‚¹æ€»ç»“

**é—®é¢˜æ ¹æº**ï¼š`RealtimeVoiceManager.initialize()` æ²¡æœ‰è¢«è°ƒç”¨

**å¯èƒ½åŸå› **ï¼ˆæŒ‰æ¦‚ç‡æ’åºï¼‰ï¼š
1. ğŸ”´ **sessionId ä¸ºç©º**ï¼ˆ80%ï¼‰
2. ğŸŸ¡ éº¦å…‹é£æƒé™æœªæ­£ç¡®æ£€æµ‹ï¼ˆ15%ï¼‰
3. ğŸŸ¢ connectionState åˆå§‹å€¼ä¸å¯¹ï¼ˆ5%ï¼‰

**è§£å†³æ–¹æ³•**ï¼šæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼Œçœ‹åˆ°åº•æ˜¯å“ªä¸ªæ¡ä»¶ä¸æ»¡è¶³

**å…ˆæ·»åŠ æ—¥å¿—ï¼Œç„¶åæŠŠè¾“å‡ºå‘ç»™æˆ‘ï¼Œæˆ‘èƒ½ç²¾å‡†å®šä½ï¼** ğŸ¯

